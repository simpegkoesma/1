<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPEG KOESMA - RSUD dr. R. KOESMA</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://github.com/simpegkoesma/1/blob/main/logo%20rsud%202%20png.png?raw=true" type="image/png">

    <!-- Libraries -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Theming System via CSS Variables */
        :root {
            --bg-body: #f4f6f9; --bg-sidebar: #2c3e50; --text-sidebar: #ecf0f1;
            --bg-card: #ffffff; --text-main: #333333; --primary: #3498db;
        }
        [data-theme="dark"] {
            --bg-body: #121212; --bg-sidebar: #1a1a1a; --text-sidebar: #e0e0e0;
            --bg-card: #1e1e1e; --text-main: #f5f5f5; --primary: #2980b9;
        }
        [data-theme="teracota"] {
            --bg-body: #fdf5e6; --bg-sidebar: #8b4513; --text-sidebar: #fff8dc;
            --bg-card: #fffaf0; --text-main: #5a3a22; --primary: #e2725b;
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: all 0.3s; }
        .sidebar { background-color: var(--bg-sidebar); color: var(--text-sidebar); transition: all 0.3s; }
        .sidebar-item:hover { background-color: rgba(255,255,255,0.1); cursor: pointer; }
        .card { background-color: var(--bg-card); color: var(--text-main); }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }

        /* Particles Layer */
        #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; background-color: #2c3e50; }
        
        #app-container { display: none; } /* Hidden by default until login */
        
        /* Modal & Loader */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;}
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- LOADING SPINNER -->
    <div id="loader"><div class="spinner"></div></div>

    <!-- LOGIN PAGE -->
    <div id="login-page" class="min-h-screen flex items-center justify-center relative">
        <div id="particles-js"></div>
        <div class="card p-8 rounded-lg shadow-2xl z-10 w-full max-w-md text-center">
            <img src="https://github.com/simpegkoesma/1/blob/main/logo%20rsud%202%20png.png?raw=true" alt="Logo RSUD dr. R. KOESMA" class="h-24 mx-auto mb-4 object-contain">
            <h1 class="text-2xl font-bold mb-2">SIMPEG KOESMA</h1>
            <p class="text-sm mb-6 opacity-70">Sistem Informasi Kepegawaian RSUD dr. R. KOESMA</p>
            <div id="g_id_onload"
                 data-client_id="33689684929-qkt221hrdr728urfjfml5od8gpla81oe.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            
            <div class="flex justify-center mt-4 w-full">
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
            </div>

        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 flex flex-col hidden md:flex absolute md:relative z-20 h-full">
            <div class="p-4 flex items-center justify-between border-b border-gray-600">
                <div class="flex items-center">
                    <img src="https://github.com/simpegkoesma/1/blob/main/logo%20rsud%202%20png.png?raw=true" alt="Logo" class="h-8 mr-3 object-contain">
                    <span class="font-bold text-lg">SIMPEG</span>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden"><i class="fas fa-times"></i></button>
            </div>
            <nav class="flex-1 overflow-y-auto p-2">
                <div class="text-xs uppercase opacity-50 px-3 mt-2 mb-1">Data Pegawai</div>
                <div id="nav-tab-profil" class="sidebar-item p-3 rounded mb-1 flex items-center bg-gray-700 bg-opacity-50" onclick="window.location.hash='profil'"><i class="fas fa-id-card mr-3 w-5"></i> Profil Utama</div>
                <div id="nav-tab-pendidikan" class="sidebar-item p-3 rounded mb-1 flex items-center" onclick="window.location.hash='pendidikan'"><i class="fas fa-graduation-cap mr-3 w-5"></i> Pendidikan</div>
                <div id="nav-tab-pangkat" class="sidebar-item p-3 rounded mb-1 flex items-center" onclick="window.location.hash='pangkat'"><i class="fas fa-medal mr-3 w-5"></i> Pangkat / Gol</div>
                <div id="nav-tab-jabatan" class="sidebar-item p-3 rounded mb-1 flex items-center" onclick="window.location.hash='jabatan'"><i class="fas fa-briefcase mr-3 w-5"></i> Jabatan</div>
                <!-- Menu Pengembangan Kompetensi -->
                <div id="nav-tab-kompetensi" class="sidebar-item p-3 rounded mb-1 flex items-center" onclick="window.location.hash='kompetensi'"><i class="fas fa-certificate mr-3 w-5"></i> Pengembangan Kompetensi</div>
                <div id="nav-tab-kgb" class="sidebar-item p-3 rounded mb-1 flex items-center" onclick="window.location.hash='kgb'"><i class="fas fa-money-bill-wave mr-3 w-5"></i> KGB</div>
                <div id="nav-tab-keluarga" class="sidebar-item p-3 rounded mb-1 flex items-center" onclick="window.location.hash='keluarga'"><i class="fas fa-users mr-3 w-5"></i> Data Keluarga</div>
                <div id="nav-tab-identitas" class="sidebar-item p-3 rounded mb-1 flex items-center" onclick="window.location.hash='identitas'"><i class="fas fa-fingerprint mr-3 w-5"></i> Identitas Lain</div>
                
                <div id="admin-menu-section" class="hidden">
                    <div class="text-xs uppercase opacity-50 px-3 mt-4 mb-1">Administrator</div>
                    <div id="menu-data-pegawai" class="sidebar-item p-3 rounded mb-1 flex items-center" onclick="window.location.hash='data-pegawai'"><i class="fas fa-users-cog mr-3 w-5"></i> Semua Pegawai</div>
                    <div id="menu-antrian" class="sidebar-item p-3 rounded mb-1 flex items-center" onclick="window.location.hash='antrian'"><i class="fas fa-tasks mr-3 w-5"></i> Antrian Update</div>
                    <div id="menu-pengaturan" class="sidebar-item p-3 rounded mb-1 flex items-center" onclick="window.location.hash='pengaturan'"><i class="fas fa-cog mr-3 w-5"></i> Pengaturan</div>
                </div>
            </nav>
            <div class="p-4 border-t border-gray-600 text-sm">
                <div id="user-info-name" class="font-bold mb-1">Nama Pegawai</div>
                <div id="user-info-role" class="text-xs uppercase opacity-75 mb-3">Role</div>
                <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded flex justify-center items-center"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden">
            <!-- Header -->
            <header class="card shadow p-4 flex justify-between items-center z-10">
                <div class="flex items-center">
                    <button onclick="toggleSidebar()" class="md:hidden text-xl mr-4"><i class="fas fa-bars"></i></button>
                    <h2 id="page-title" class="font-bold text-xl">Profil Saya</h2>
                </div>
                <div class="flex items-center">
                    <button onclick="exportMyData()" id="btn-export-pdf" class="btn-primary px-3 py-1 text-sm rounded mr-2"><i class="fas fa-file-pdf mr-1"></i> Cetak CV</button>
                </div>
            </header>

            <!-- Pages -->
            <div class="p-4 md:p-6 flex-1 overflow-y-auto" id="main-scroll-area">
                
                <!-- Page: Dashboard (Tab Container) -->
                <div id="page-dashboard" class="page-content">
                    <div class="card rounded-lg shadow-md p-6 mb-6 flex flex-col md:flex-row items-center">
                        <div class="w-32 h-32 rounded-full overflow-hidden bg-gray-300 mb-4 md:mb-0 md:mr-6 relative group flex-shrink-0">
                            <img id="profile-img" src="https://via.placeholder.com/150" alt="Foto Profil" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="document.getElementById('file-upload').click()">
                                <span class="text-white text-xs text-center">Ubah Foto</span>
                            </div>
                            <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="uploadFoto(this)">
                        </div>
                        <div class="flex-1 w-full text-center md:text-left overflow-hidden">
                            <h3 id="p-nama" class="text-2xl font-bold truncate">Memuat...</h3>
                            <p id="p-nip" class="opacity-75 mb-2">NIP: -</p>
                            <span id="p-status" class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold">AKTIF</span>
                        </div>
                        <div class="mt-4 md:mt-0 md:text-right text-center w-full md:w-auto">
                            <p class="text-sm opacity-75">Unit Kerja</p>
                            <p id="p-unit" class="font-bold">RSUD dr. R. KOESMA</p>
                        </div>
                    </div>

                    <!-- Tab Content: Profil Utama -->
                    <div id="tab-profil" class="user-tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="card rounded-lg shadow-md p-6">
                                <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200">
                                    <h4 class="font-bold text-lg"><i class="fas fa-id-card mr-2 text-blue-500"></i> Data Personal</h4>
                                </div>
                                <table class="w-full text-sm">
                                    <tr class="border-b border-gray-100"><td class="py-2 opacity-75 w-1/3">Tempat Lahir</td><td id="p-tempatlahir" class="font-medium">-</td><td class="text-right w-8"><button onclick="editField('PROFIL', 'Tempat_Lahir')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                    <tr class="border-b border-gray-100"><td class="py-2 opacity-75 w-1/3">Tanggal Lahir</td><td id="p-tgllahir" class="font-medium">-</td><td class="text-right"><button onclick="editField('PROFIL', 'Tgl_Lahir')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                    <tr class="border-b border-gray-100"><td class="py-2 opacity-75">Jenis Kelamin</td><td id="p-jk" class="font-medium">-</td><td class="text-right"><button onclick="editField('PROFIL', 'Jenis_Kelamin')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                    <tr class="border-b border-gray-100"><td class="py-2 opacity-75">Agama</td><td id="p-agama" class="font-medium">-</td><td class="text-right"><button onclick="editField('PROFIL', 'Agama')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                    <tr class="border-b border-gray-100"><td class="py-2 opacity-75">Alamat</td><td id="p-alamat" class="font-medium">-</td><td class="text-right"><button onclick="editField('PROFIL', 'Alamat_Domisili')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                    <tr><td class="py-2 opacity-75">No HP</td><td id="p-hp" class="font-medium">-</td><td class="text-right"><button onclick="editField('PROFIL', 'No_HP')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                </table>
                            </div>
                            <div class="card rounded-lg shadow-md p-6">
                                <h4 class="font-bold text-lg mb-4 border-b pb-2 border-gray-200"><i class="fas fa-briefcase mr-2 text-blue-500"></i> Karir & Ringkasan</h4>
                                <table class="w-full text-sm">
                                    <tr class="border-b border-gray-100"><td class="py-2 opacity-75 w-1/3">Jenis ASN</td><td id="p-jasn" class="font-medium">-</td><td class="text-right w-8"><button onclick="editField('PROFIL', 'Jenis_ASN')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                    <tr class="border-b border-gray-100"><td class="py-2 opacity-75">Pangkat/Gol</td><td id="p-pangkat" class="font-medium">-</td><td class="text-right"><button onclick="editField('PROFIL', 'Pangkat_Golongan')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                    <tr class="border-b border-gray-100"><td class="py-2 opacity-75">Jabatan Terakhir</td><td id="p-jabatan" class="font-medium">-</td><td class="text-right"><button onclick="editField('PROFIL', 'Jabatan_Terakhir')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                    <tr><td class="py-2 opacity-75">Pendidikan</td><td id="p-pendidikan" class="font-medium">-</td><td class="text-right"><button onclick="editField('PROFIL', 'Jenjang_Pendidikan')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                </table>
                            </div>
                        </div>

                        <!-- Riwayat Antrian User -->
                        <div class="card rounded-lg shadow-md p-6 mt-6">
                            <h4 class="font-bold text-lg mb-4 border-b pb-2 border-gray-200"><i class="fas fa-history mr-2 text-blue-500"></i> Riwayat Pengajuan Perubahan Data</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-gray-200 text-black">
                                        <tr>
                                            <th class="p-2">Tgl Ajuan</th>
                                            <th class="p-2">Data/Kolom Target</th>
                                            <th class="p-2">Nilai Diajukan</th>
                                            <th class="p-2">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-my-antrian">
                                        <tr><td colspan="4" class="text-center p-4">Sedang memuat data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Pendidikan -->
                    <div id="tab-pendidikan" class="user-tab-content hidden">
                        <div class="card rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h4 class="font-bold text-lg"><i class="fas fa-graduation-cap mr-2 text-blue-500"></i> Riwayat Pendidikan</h4>
                                <button onclick="ajukanRiwayat('RIWAYAT_PENDIDIKAN')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm shadow"><i class="fas fa-plus mr-1"></i> Tambah Data & Ijazah</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-gray-100 text-black whitespace-nowrap">
                                        <tr>
                                            <th class="p-2">Jenjang</th>
                                            <th class="p-2">Instansi</th>
                                            <th class="p-2">Jurusan</th>
                                            <th class="p-2">Thn Lulus</th>
                                            <th class="p-2">No. Ijazah</th>
                                            <th class="p-2">Tgl Ijazah</th>
                                            <th class="p-2">Pdd. Terakhir</th>
                                            <th class="p-2">File</th>
                                            <th class="p-2 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-pendidikan">
                                        <tr><td colspan="9" class="text-center p-4 text-gray-500">Sedang memuat...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Pangkat -->
                    <div id="tab-pangkat" class="user-tab-content hidden">
                        <div class="card rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h4 class="font-bold text-lg"><i class="fas fa-medal mr-2 text-blue-500"></i> Riwayat Pangkat</h4>
                                <button onclick="ajukanRiwayat('RIWAYAT_PANGKAT')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm shadow"><i class="fas fa-plus mr-1"></i> Tambah Data & SK</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm whitespace-nowrap">
                                    <thead class="bg-gray-100 text-black">
                                        <tr>
                                            <th class="p-2">Pangkat/Gol</th>
                                            <th class="p-2">No SK</th>
                                            <th class="p-2">TMT</th>
                                            <th class="p-2">Tgl SK</th>
                                            <th class="p-2">Masa Kerja</th>
                                            <th class="p-2">Pangkat Sekarang</th>
                                            <th class="p-2">File SK</th>
                                            <th class="p-2 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-pangkat">
                                        <tr><td colspan="8" class="text-center p-4 text-gray-500">Sedang memuat...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Jabatan -->
                    <div id="tab-jabatan" class="user-tab-content hidden">
                        <div class="card rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h4 class="font-bold text-lg"><i class="fas fa-briefcase mr-2 text-blue-500"></i> Riwayat Jabatan</h4>
                                <button onclick="ajukanRiwayat('RIWAYAT_JABATAN')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm shadow"><i class="fas fa-plus mr-1"></i> Ajukan Data & SK</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm whitespace-nowrap">
                                    <thead class="bg-gray-100 text-black">
                                        <tr>
                                            <th class="p-2">Jenis Jabatan</th>
                                            <th class="p-2">Nama Jabatan</th>
                                            <th class="p-2">Eselon</th>
                                            <th class="p-2">Unit Kerja</th>
                                            <th class="p-2">TMT Pelantikan</th>
                                            <th class="p-2">Jabatan Sekarang</th>
                                            <th class="p-2">File SK</th>
                                            <th class="p-2 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-jabatan">
                                        <tr><td colspan="8" class="text-center p-4 text-gray-500">Sedang memuat...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Kompetensi -->
                    <div id="tab-kompetensi" class="user-tab-content hidden">
                        <div class="card rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h4 class="font-bold text-lg"><i class="fas fa-certificate mr-2 text-blue-500"></i> Pengembangan Kompetensi</h4>
                                <button onclick="ajukanRiwayat('RIWAYAT_KOMPETENSI')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm shadow"><i class="fas fa-plus mr-1"></i> Ajukan Kompetensi / Diklat</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm whitespace-nowrap">
                                    <thead class="bg-gray-100 text-black">
                                        <tr>
                                            <th class="p-2">Jenis Diklat</th>
                                            <th class="p-2">Nama Diklat</th>
                                            <th class="p-2">Pelaksanaan</th>
                                            <th class="p-2">JP</th>
                                            <th class="p-2">Penyelenggara</th>
                                            <th class="p-2">Anggaran</th>
                                            <th class="p-2">No. Sertifikat</th>
                                            <th class="p-2">File</th>
                                            <th class="p-2 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-kompetensi">
                                        <tr><td colspan="9" class="text-center p-4 text-gray-500">Sedang memuat...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: KGB -->
                    <div id="tab-kgb" class="user-tab-content hidden">
                        <div class="card rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h4 class="font-bold text-lg"><i class="fas fa-money-bill-wave mr-2 text-blue-500"></i> Riwayat KGB</h4>
                                <button onclick="ajukanRiwayat('RIWAYAT_KGB')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm shadow"><i class="fas fa-plus mr-1"></i> Ajukan Data Baru</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm whitespace-nowrap">
                                    <thead class="bg-gray-100 text-black">
                                        <tr><th class="p-2">Golongan</th><th class="p-2">Gaji Baru</th><th class="p-2">TMT</th><th class="p-2">No SK Dasar</th><th class="p-2 text-center">Aksi</th></tr>
                                    </thead>
                                    <tbody id="tbody-kgb">
                                        <tr><td colspan="5" class="text-center p-4 text-gray-500">Sedang memuat...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Keluarga -->
                    <div id="tab-keluarga" class="user-tab-content hidden">
                        <div class="card rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h4 class="font-bold text-lg"><i class="fas fa-users mr-2 text-blue-500"></i> Data Keluarga</h4>
                                <button onclick="ajukanRiwayat('DATA_KELUARGA')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm shadow"><i class="fas fa-plus mr-1"></i> Tambah Anggota</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm whitespace-nowrap">
                                    <thead class="bg-gray-100 text-black">
                                        <tr><th class="p-2">Nama</th><th class="p-2">Status</th><th class="p-2">L/P</th><th class="p-2">Tunjangan</th><th class="p-2 text-center">Aksi</th></tr>
                                    </thead>
                                    <tbody id="tbody-keluarga">
                                        <tr><td colspan="5" class="text-center p-4 text-gray-500">Sedang memuat...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Identitas Lain -->
                    <div id="tab-identitas" class="user-tab-content hidden">
                        <div class="card rounded-lg shadow-md p-6 max-w-2xl mx-auto">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h4 class="font-bold text-lg"><i class="fas fa-fingerprint mr-2 text-blue-500"></i> Identitas Lain</h4>
                            </div>
                            <table class="w-full text-sm">
                                <tr class="border-b border-gray-100"><td class="py-2 opacity-75 w-1/3">NIK (KTP)</td><td id="p-nik" class="font-medium">-</td><td class="text-right w-8"><button onclick="editField('IDENTITAS_LAIN', 'NIK_KTP')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                <tr class="border-b border-gray-100"><td class="py-2 opacity-75 w-1/3">NPWP</td><td id="p-npwp" class="font-medium">-</td><td class="text-right"><button onclick="editField('IDENTITAS_LAIN', 'No_NPWP')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                <tr class="border-b border-gray-100"><td class="py-2 opacity-75">BPJS</td><td id="p-bpjs" class="font-medium">-</td><td class="text-right"><button onclick="editField('IDENTITAS_LAIN', 'No_BPJS')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                                <tr><td class="py-2 opacity-75">TASPEN</td><td id="p-taspen" class="font-medium">-</td><td class="text-right"><button onclick="editField('IDENTITAS_LAIN', 'No_TASPEN')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td></tr>
                            </table>
                        </div>
                    </div>

                </div>

                <!-- Page: Data Pegawai (Admin) -->
                <div id="page-data-pegawai" class="page-content hidden">
                    <div class="card rounded-lg shadow-md p-6">
                        <div class="flex justify-between mb-4 flex-col md:flex-row gap-2">
                            <input type="text" id="search-pegawai" placeholder="Cari Nama/NIP..." class="border p-2 rounded w-full md:w-64 text-black" onkeyup="filterTablePegawai()">
                            <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"><i class="fas fa-file-excel mr-2"></i> Export Excel</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap" id="table-pegawai">
                                <thead class="bg-gray-200 text-black">
                                    <tr>
                                        <th class="p-3">NIP</th>
                                        <th class="p-3">Nama Pegawai</th>
                                        <th class="p-3">Jabatan</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-pegawai">
                                    <!-- Dynamic rows -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Kontainer Paginasi Baru -->
                        <div class="flex justify-between items-center mt-4 text-sm" id="pagination-container">
                            <div class="text-gray-500 font-medium" id="pagination-info">Menampilkan 0 data</div>
                            <div class="flex items-center space-x-1" id="pagination-controls">
                                <!-- Tombol-tombol paginasi akan dirender oleh JavaScript -->
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Page: Antrian Update (Admin) -->
                <div id="page-antrian" class="page-content hidden">
                    <div class="card rounded-lg shadow-md p-6">
                        <div class="flex justify-between mb-4 items-center flex-col md:flex-row gap-4">
                            <h3 class="font-bold text-lg">Daftar Pengajuan Perubahan Data</h3>
                            <div id="bulk-action-container" class="hidden flex space-x-2">
                                <button onclick="prosesBulkAntrian('Approved')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm shadow"><i class="fas fa-check-double mr-1"></i> Setujui Terpilih</button>
                                <button onclick="prosesBulkAntrian('Rejected')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm shadow"><i class="fas fa-times-circle mr-1"></i> Tolak Terpilih</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-200 text-black">
                                    <tr>
                                        <th class="p-2 w-10 text-center"><input type="checkbox" id="cb-select-all" onchange="toggleSelectAllAntrian(this)"></th>
                                        <th class="p-2">Tgl Ajuan</th>
                                        <th class="p-2">Nama Pengaju</th>
                                        <th class="p-2">Target Data</th>
                                        <th class="p-2 max-w-xs">Nilai Baru</th>
                                        <th class="p-2">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-antrian">
                                    <tr><td colspan="6" class="text-center p-4">Sedang memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Pengaturan -->
                <div id="page-pengaturan" class="page-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card rounded-lg shadow-md p-6">
                            <h3 class="font-bold text-lg mb-4 border-b pb-2"><i class="fas fa-palette mr-2"></i> Tema Aplikasi</h3>
                            <div class="flex flex-col space-y-3">
                                <label class="flex items-center"><input type="radio" name="theme" value="light" onchange="setTheme('light')" class="mr-2"> Light Mode</label>
                                <label class="flex items-center"><input type="radio" name="theme" value="dark" onchange="setTheme('dark')" class="mr-2"> Dark Mode</label>
                                <label class="flex items-center"><input type="radio" name="theme" value="teracota" onchange="setTheme('teracota')" class="mr-2"> Teracota</label>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // CONFIGURATION
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw6dOG2OHt3ioevOsrUSLJOhLJw1EyWn_t1RBnDNiBXKcSfxdUy8i_hklvOAT2Y1RgTEA/exec';
        
        let STATE = { user: null, profile: null, riwayat: {}, identitasLain: null, allPegawai: [], myAntrian: [], filteredPegawai: [], currentPage: 1, rowsPerPage: 15 };

        // Konfigurasi SweetAlert2 Toast (Notifikasi Pojok Kanan Atas)
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        // ==========================================
        // 1. INITIALIZATION & ROUTING LOGIC (SPA)
        // ==========================================
        window.onload = () => {
            initParticles();
            loadTheme();
            const savedUser = localStorage.getItem('simpeg_user');
            if (savedUser) {
                STATE.user = JSON.parse(savedUser);
                showApp();
            }

            // Mendaftarkan event listener untuk Router URL Hash
            window.addEventListener('hashchange', () => {
                if(STATE.user) handleRouting();
            });
        };

        // Fungsi Routing Sentral
        function handleRouting() {
            let hash = window.location.hash.substring(1) || 'profil';

            // Proteksi Routing untuk halaman Admin
            if (['data-pegawai', 'antrian', 'pengaturan'].includes(hash) && !['admin', 'superadmin'].includes(STATE.user?.role)) {
                hash = 'profil';
                window.location.hash = hash;
                return;
            }

            // Sembunyikan seluruh halaman
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));

            // Tentukan Page ID tujuan
            let pageId = 'dashboard'; // Dashboard adalah container untuk semua tab user (profil, pendidikan, dsb)
            if (['data-pegawai', 'antrian', 'pengaturan'].includes(hash)) {
                pageId = hash;
            }

            // Tampilkan halaman
            document.getElementById('page-' + pageId).classList.remove('hidden');

            // Set Judul Halaman
            const titles = { 
                'profil':'Profil Utama', 'pendidikan':'Pendidikan', 'pangkat':'Pangkat / Gol',
                'jabatan':'Jabatan', 'kompetensi': 'Pengembangan Kompetensi', 'kgb':'KGB', 'keluarga':'Data Keluarga', 'identitas':'Identitas Lain',
                'data-pegawai':'Data Pegawai', 'antrian':'Antrian Update', 'pengaturan':'Pengaturan' 
            };
            document.getElementById('page-title').innerText = titles[hash] || 'Profil Saya';

            // Logika khusus: Jika ini halaman dashboard, tentukan tab mana yang aktif
            if (pageId === 'dashboard') {
                document.querySelectorAll('.user-tab-content').forEach(el => el.classList.add('hidden'));
                const targetTab = document.getElementById('tab-' + hash);
                if (targetTab) targetTab.classList.remove('hidden');
            }

            // Update Highlight Sidebar Aktif
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('bg-gray-700', 'bg-opacity-50'));
            const activeNav = document.getElementById('nav-tab-' + hash) || document.getElementById('menu-' + hash);
            if(activeNav) activeNav.classList.add('bg-gray-700', 'bg-opacity-50');

            // Auto-close sidebar di mode mobile setelah klik menu
            if(window.innerWidth < 768 && !document.getElementById('sidebar').classList.contains('hidden')) {
                toggleSidebar();
            }

            // Panggil API Fetch jika membuka halaman spesifik admin
            if(hash === 'data-pegawai') fetchAllPegawai();
            if(hash === 'antrian') fetchAllAntrian();
            
            // Simpan posisi terakhir pengguna
            sessionStorage.setItem('simpeg_active_hash', hash);
        }

        function initParticles() {
            particlesJS("particles-js", {
                "particles": {"number": {"value": 80},"color": {"value": "#ffffff"},"shape": {"type": "circle"},"opacity": {"value": 0.5},"size": {"value": 3},"line_linked": {"enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.4, "width": 1},"move": {"enable": true, "speed": 2}},
                "interactivity": {"events": {"onhover": {"enable": true, "mode": "grab"}}}
            });
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('hidden');
        }

        function loadTheme() {
            const theme = localStorage.getItem('simpeg_theme') || 'light';
            document.body.setAttribute('data-theme', theme);
            const r = document.querySelector(`input[name="theme"][value="${theme}"]`);
            if(r) r.checked = true;
        }

        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('simpeg_theme', theme);
        }

        function showLoader(show=true) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

        // ==========================================
        // 2. AUTHENTICATION & GOOGLE SSO
        // ==========================================
        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        async function handleCredentialResponse(response) {
            showLoader();
            try {
                const payload = parseJwt(response.credential);
                const email = payload.email;

                const res = await apiCall({ action: 'login', email: email });
                
                if (res.needNip) {
                    showLoader(false);
                    promptLinkNIP(email, res.role);
                } else {
                    STATE.user = res.user;
                    localStorage.setItem('simpeg_user', JSON.stringify(STATE.user));
                    showApp();
                }
            } catch (err) {
                showLoader(false);
                Swal.fire('Error', err.message, 'error');
            }
        }

        async function promptLinkNIP(email, role) {
            const { value: nip } = await Swal.fire({
                title: 'Akun Belum Ditautkan',
                text: `Email ${email} belum memiliki NIP. Masukkan NIP Anda:`,
                input: 'text',
                inputPlaceholder: 'Masukkan NIP 18 Digit',
                allowOutsideClick: false,
                showCancelButton: true
            });

            if (nip) {
                showLoader();
                try {
                    const res = await apiCall({ action: 'linkNip', email: email, nip: nip, role: role });
                    Swal.fire('Sukses', res.message, 'success');
                    STATE.user = res.user;
                    localStorage.setItem('simpeg_user', JSON.stringify(STATE.user));
                    showApp();
                } catch (err) {
                    showLoader(false);
                    Swal.fire('Gagal Menautkan', err.message, 'error');
                }
            }
        }

        function logout() {
            localStorage.removeItem('simpeg_user');
            sessionStorage.removeItem('simpeg_active_hash');
            STATE.user = null;
            
            // Bersihkan URL Hash
            history.pushState("", document.title, window.location.pathname + window.location.search);
            
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
        }

        async function showApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            // Set User Info
            document.getElementById('user-info-name').innerText = STATE.user.nip;
            document.getElementById('user-info-role').innerText = STATE.user.role;

            // RBAC UI Render
            if (['admin', 'superadmin'].includes(STATE.user.role)) {
                document.getElementById('admin-menu-section').classList.remove('hidden');
            }

            // Load Profile
            await fetchProfile();
            
            // Panggil Router untuk menampilkan UI berdasarkan URL / Memory saat ini
            const urlHash = window.location.hash.substring(1);
            const savedHash = sessionStorage.getItem('simpeg_active_hash');
            
            if (!urlHash) {
                window.location.hash = savedHash || 'profil';
            } else {
                handleRouting();
            }
            
            showLoader(false);
        }

        // ==========================================
        // 3. DATA FETCHING & RENDERING
        // ==========================================
        async function fetchProfile() {
            try {
                const res = await apiCall({ action: 'getProfile', nip: STATE.user.nip });
                STATE.profile = res.data;
                
                // Simpan Riwayat
                STATE.riwayat.pendidikan = res.riwayat_pendidikan || [];
                STATE.riwayat.pangkat = res.riwayat_pangkat || [];
                STATE.riwayat.jabatan = res.riwayat_jabatan || [];
                STATE.riwayat.kompetensi = res.riwayat_kompetensi || []; // Simpan Kompetensi
                STATE.riwayat.kgb = res.riwayat_kgb || [];
                STATE.riwayat.keluarga = res.data_keluarga || [];
                STATE.identitasLain = (res.identitas_lain && res.identitas_lain.length > 0) ? res.identitas_lain[0] : {};
                
                if(STATE.profile) {
                    // Panggil data antrian milik user ini terlebih dahulu agar status verifikasi dapat dicek
                    await fetchMyAntrian();

                    document.getElementById('user-info-name').innerText = STATE.profile.Nama_Lengkap;
                    document.getElementById('p-nama').innerText = (STATE.profile.Gelar_Depan?STATE.profile.Gelar_Depan+' ':'') + STATE.profile.Nama_Lengkap + (STATE.profile.Gelar_Belakang?', '+STATE.profile.Gelar_Belakang:'');
                    document.getElementById('p-nip').innerText = "NIP: " + STATE.profile.NIP;
                    document.getElementById('p-unit').innerText = STATE.profile.Unit_Kerja || '-';
                    
                    document.getElementById('p-status').innerText = STATE.profile.Status_Pegawai || 'AKTIF';
                    if(STATE.profile.URL_Foto_Profil) {
                        document.getElementById('profile-img').src = STATE.profile.URL_Foto_Profil;
                    }

                    // Render Data Utama & Semua Riwayat
                    updateProfileUI();
                    renderSemuaRiwayat();
                }
            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'Gagal memuat profil', 'error');
            }
        }

        // --- Logika Status Pending untuk Profil / Data Utama ---
        function getFieldHTML(kolom, currentValue) {
            if (!STATE.myAntrian) return `${currentValue || '-'} <i class="fas fa-check-circle text-green-500 ml-1" title="Sudah Disetujui / Aktif"></i>`;
            const pendingReq = STATE.myAntrian.find(a => a.Kolom_Tujuan === kolom && a.Status === 'Pending');

            if (pendingReq) {
                return `<span class="text-yellow-600 font-bold" title="Sedang diajukan: ${pendingReq.Nilai_Baru}">${pendingReq.Nilai_Baru} <i class="fas fa-clock text-yellow-500 ml-1"></i><span class="text-xs ml-1 bg-yellow-100 text-yellow-700 px-1 py-0.5 rounded">Menunggu verifikasi</span></span>`;
            }
            return `${currentValue || '-'} <i class="fas fa-check-circle text-green-500 ml-1" title="Sudah Disetujui / Aktif"></i>`;
        }

        // --- Logika Status Pending Spesifik per Baris ID_Data Riwayat ---
        function getRiwayatFieldHTML(idData, kolom, currentValue) {
            if (!STATE.myAntrian) return currentValue || '-';
            // Cek di antrian apakah ada pengajuan update untuk sel (baris idData dan kolom) ini
            const pendingReq = STATE.myAntrian.find(a => String(a.Baris_Target) === String(idData) && a.Kolom_Tujuan === kolom && a.Status === 'Pending');

            if (pendingReq) {
                return `<span class="text-yellow-600 font-bold" title="Sedang diajukan: ${pendingReq.Nilai_Baru}">${pendingReq.Nilai_Baru} <i class="fas fa-clock text-yellow-500 ml-1"></i></span>`;
            }
            return currentValue || '-';
        }

        function updateProfileUI() {
            // PROFIL
            document.getElementById('p-tempatlahir').innerHTML = getFieldHTML('Tempat_Lahir', STATE.profile.Tempat_Lahir);
            document.getElementById('p-tgllahir').innerHTML = getFieldHTML('Tgl_Lahir', STATE.profile.Tgl_Lahir ? new Date(STATE.profile.Tgl_Lahir).toLocaleDateString('id-ID') : '');
            document.getElementById('p-jk').innerHTML = getFieldHTML('Jenis_Kelamin', STATE.profile.Jenis_Kelamin);
            document.getElementById('p-agama').innerHTML = getFieldHTML('Agama', STATE.profile.Agama);
            document.getElementById('p-alamat').innerHTML = getFieldHTML('Alamat_Domisili', STATE.profile.Alamat_Domisili);
            document.getElementById('p-hp').innerHTML = getFieldHTML('No_HP', STATE.profile.No_HP);
            document.getElementById('p-jasn').innerHTML = getFieldHTML('Jenis_ASN', STATE.profile.Jenis_ASN);
            document.getElementById('p-pangkat').innerHTML = getFieldHTML('Pangkat_Golongan', STATE.profile.Pangkat_Golongan);
            document.getElementById('p-jabatan').innerHTML = getFieldHTML('Jabatan_Terakhir', STATE.profile.Jabatan_Terakhir);
            document.getElementById('p-pendidikan').innerHTML = getFieldHTML('Jenjang_Pendidikan', STATE.profile.Jenjang_Pendidikan);

            // IDENTITAS LAIN (karena formatnya 1 NIP = 1 Baris seperti Profil Utama)
            document.getElementById('p-nik').innerHTML = getFieldHTML('NIK_KTP', STATE.identitasLain.NIK_KTP);
            document.getElementById('p-npwp').innerHTML = getFieldHTML('No_NPWP', STATE.identitasLain.No_NPWP);
            document.getElementById('p-bpjs').innerHTML = getFieldHTML('No_BPJS', STATE.identitasLain.No_BPJS);
            document.getElementById('p-taspen').innerHTML = getFieldHTML('No_TASPEN', STATE.identitasLain.No_TASPEN);
        }

        function renderSemuaRiwayat() {
            // 1. PENDIDIKAN
            const tbodyPend = document.getElementById('tbody-pendidikan');
            tbodyPend.innerHTML = '';
            if (STATE.riwayat.pendidikan.length > 0) {
                STATE.riwayat.pendidikan.forEach(p => {
                    let fileBtn = p.File_Ijazah ? `<a href="${p.File_Ijazah}" target="_blank" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs hover:bg-blue-200 whitespace-nowrap"><i class="fas fa-file-pdf"></i> Lihat File</a>` : '-';
                    tbodyPend.innerHTML += `<tr class="border-b">
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Jenjang', p.Jenjang)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Instansi', p.Instansi)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Jurusan', p.Jurusan)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Thn_Lulus', p.Thn_Lulus)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'No_Ijazah', p.No_Ijazah)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Tgl_Ijazah', p.Tgl_Ijazah ? new Date(p.Tgl_Ijazah).toLocaleDateString('id-ID') : '')}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Pendidikan_Terakhir', p.Pendidikan_Terakhir)}</td>
                        <td class="p-2">${fileBtn}</td>
                        <td class="p-2 text-center"><button onclick="editRiwayatRow('${p.ID_Data}', 'RIWAYAT_PENDIDIKAN')" class="text-blue-600 hover:text-blue-800 bg-blue-50 px-2 py-1 rounded border border-blue-200 shadow-sm text-xs"><i class="fas fa-edit"></i> Edit</button></td>
                    </tr>`;
                });
            } else { tbodyPend.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-gray-500">Belum ada data pendidikan.</td></tr>`; }

            // 2. PANGKAT
            const tbodyPangkat = document.getElementById('tbody-pangkat');
            tbodyPangkat.innerHTML = '';
            if (STATE.riwayat.pangkat.length > 0) {
                STATE.riwayat.pangkat.forEach(p => {
                    let fileBtn = p.File_SK ? `<a href="${p.File_SK}" target="_blank" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs hover:bg-blue-200 whitespace-nowrap"><i class="fas fa-file-pdf"></i> Lihat SK</a>` : '-';
                    tbodyPangkat.innerHTML += `<tr class="border-b">
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Pangkat_Gol', p.Pangkat_Gol)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'No_SK', p.No_SK)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'TMT', p.TMT ? new Date(p.TMT).toLocaleDateString('id-ID') : '')}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Tgl_SK', p.Tgl_SK ? new Date(p.Tgl_SK).toLocaleDateString('id-ID') : '')}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Masa_Kerja_Thn', p.Masa_Kerja_Thn)} Thn, ${getRiwayatFieldHTML(p.ID_Data, 'Masa_Kerja_Bln', p.Masa_Kerja_Bln)} Bln</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Pangkat_Sekarang', p.Pangkat_Sekarang)}</td>
                        <td class="p-2">${fileBtn}</td>
                        <td class="p-2 text-center"><button onclick="editRiwayatRow('${p.ID_Data}', 'RIWAYAT_PANGKAT')" class="text-blue-600 hover:text-blue-800 bg-blue-50 px-2 py-1 rounded border border-blue-200 shadow-sm text-xs"><i class="fas fa-edit"></i> Edit</button></td>
                    </tr>`;
                });
            } else { tbodyPangkat.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-gray-500">Belum ada data pangkat.</td></tr>`; }

            // 3. JABATAN
            const tbodyJabatan = document.getElementById('tbody-jabatan');
            tbodyJabatan.innerHTML = '';
            if (STATE.riwayat.jabatan.length > 0) {
                STATE.riwayat.jabatan.forEach(p => {
                    let fileBtn = p.File_SK ? `<a href="${p.File_SK}" target="_blank" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs hover:bg-blue-200 whitespace-nowrap"><i class="fas fa-file-pdf"></i> Lihat SK</a>` : '-';
                    tbodyJabatan.innerHTML += `<tr class="border-b">
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Jenis_Jabatan', p.Jenis_Jabatan)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Jabatan', p.Jabatan)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Eselon', p.Eselon)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Unit_Kerja', p.Unit_Kerja)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'TMT_Pelantikan', p.TMT_Pelantikan ? new Date(p.TMT_Pelantikan).toLocaleDateString('id-ID') : '')}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Jabatan_Sekarang', p.Jabatan_Sekarang)}</td>
                        <td class="p-2">${fileBtn}</td>
                        <td class="p-2 text-center"><button onclick="editRiwayatRow('${p.ID_Data}', 'RIWAYAT_JABATAN')" class="text-blue-600 hover:text-blue-800 bg-blue-50 px-2 py-1 rounded border border-blue-200 shadow-sm text-xs"><i class="fas fa-edit"></i> Edit</button></td>
                    </tr>`;
                });
            } else { tbodyJabatan.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-gray-500">Belum ada data jabatan.</td></tr>`; }

            // 3B. KOMPETENSI / DIKLAT
            const tbodyKompetensi = document.getElementById('tbody-kompetensi');
            tbodyKompetensi.innerHTML = '';
            if (STATE.riwayat.kompetensi.length > 0) {
                STATE.riwayat.kompetensi.forEach(p => {
                    let fileBtn = p.File_Sertifikat ? `<a href="${p.File_Sertifikat}" target="_blank" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs hover:bg-blue-200 whitespace-nowrap"><i class="fas fa-file-pdf"></i> Lihat Sertifikat</a>` : '-';
                    let tglMulai = p.Tgl_Mulai ? new Date(p.Tgl_Mulai).toLocaleDateString('id-ID') : '-';
                    let tglSelesai = p.Tgl_Selesai ? new Date(p.Tgl_Selesai).toLocaleDateString('id-ID') : '-';
                    let pelaksanaanHTML = getRiwayatFieldHTML(p.ID_Data, 'Tgl_Mulai', tglMulai) + ' s/d ' + getRiwayatFieldHTML(p.ID_Data, 'Tgl_Selesai', tglSelesai);
                    
                    tbodyKompetensi.innerHTML += `<tr class="border-b">
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Jenis_Diklat', p.Jenis_Diklat)}</td>
                        <td class="p-2 max-w-xs break-words whitespace-normal">${getRiwayatFieldHTML(p.ID_Data, 'Nama_Diklat', p.Nama_Diklat)}</td>
                        <td class="p-2 whitespace-nowrap">${pelaksanaanHTML}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Jumlah_JP', p.Jumlah_JP)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Penyelenggara', p.Penyelenggara)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Sumber_Anggaran', p.Sumber_Anggaran)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'No_Sertifikat', p.No_Sertifikat)}</td>
                        <td class="p-2">${fileBtn}</td>
                        <td class="p-2 text-center"><button onclick="editRiwayatRow('${p.ID_Data}', 'RIWAYAT_KOMPETENSI')" class="text-blue-600 hover:text-blue-800 bg-blue-50 px-2 py-1 rounded border border-blue-200 shadow-sm text-xs"><i class="fas fa-edit"></i> Edit</button></td>
                    </tr>`;
                });
            } else { tbodyKompetensi.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-gray-500">Belum ada data pengembangan kompetensi.</td></tr>`; }

            // 4. KGB
            const tbodyKgb = document.getElementById('tbody-kgb');
            tbodyKgb.innerHTML = '';
            if (STATE.riwayat.kgb.length > 0) {
                STATE.riwayat.kgb.forEach(p => {
                    tbodyKgb.innerHTML += `<tr class="border-b">
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Golongan', p.Golongan)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Gaji_Baru', p.Gaji_Baru)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'KGB_TMT', p.KGB_TMT)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Dasar_Nomor', p.Dasar_Nomor)}</td>
                        <td class="p-2 text-center"><button onclick="editRiwayatRow('${p.ID_Data}', 'RIWAYAT_KGB')" class="text-blue-600 hover:text-blue-800 bg-blue-50 px-2 py-1 rounded border border-blue-200 shadow-sm text-xs"><i class="fas fa-edit"></i> Edit</button></td>
                    </tr>`;
                });
            } else { tbodyKgb.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">Belum ada data KGB.</td></tr>`; }

            // 5. KELUARGA
            const tbodyKeluarga = document.getElementById('tbody-keluarga');
            tbodyKeluarga.innerHTML = '';
            if (STATE.riwayat.keluarga.length > 0) {
                STATE.riwayat.keluarga.forEach(p => {
                    tbodyKeluarga.innerHTML += `<tr class="border-b">
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Nama', p.Nama)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Status_Keluarga', p.Status_Keluarga)}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'L/P', p['L/P'])}</td>
                        <td class="p-2">${getRiwayatFieldHTML(p.ID_Data, 'Tunjangan', p.Tunjangan)}</td>
                        <td class="p-2 text-center"><button onclick="editRiwayatRow('${p.ID_Data}', 'DATA_KELUARGA')" class="text-blue-600 hover:text-blue-800 bg-blue-50 px-2 py-1 rounded border border-blue-200 shadow-sm text-xs"><i class="fas fa-edit"></i> Edit</button></td>
                    </tr>`;
                });
            } else { tbodyKeluarga.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">Belum ada data keluarga.</td></tr>`; }
        }

        async function fetchMyAntrian() {
            try {
                const res = await apiCall({ action: 'getUserAntrian', nip: STATE.user.nip });
                STATE.myAntrian = res.data || [];
                
                const tbody = document.getElementById('tbody-my-antrian');
                tbody.innerHTML = '';
                
                if(!res.data || res.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 opacity-70">Belum ada pengajuan perubahan data.</td></tr>';
                    return;
                }

                res.data.reverse().forEach(a => {
                    let statusColor = 'bg-yellow-100 text-yellow-800';
                    let statusIcon = '<i class="fas fa-clock"></i> Pending';
                    if(a.Status === 'Approved') { statusColor = 'bg-green-100 text-green-800'; statusIcon = '<i class="fas fa-check"></i> Disetujui'; }
                    if(a.Status === 'Rejected') { statusColor = 'bg-red-100 text-red-800'; statusIcon = '<i class="fas fa-times"></i> Ditolak'; }
                    
                    const tgl = new Date(a.Tgl_Pengajuan).toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'});
                    
                    tbody.innerHTML += `
                        <tr class="border-b border-gray-300 hover:bg-gray-50">
                            <td class="p-2 whitespace-nowrap">${tgl}</td>
                            <td class="p-2 font-medium text-blue-600">${a.Kolom_Tujuan.replace(/_/g, ' ')}</td>
                            <td class="p-2 max-w-xs truncate" title="${a.Nilai_Baru}">${a.Nilai_Baru}</td>
                            <td class="p-2"><span class="px-2 py-1 ${statusColor} rounded text-xs whitespace-nowrap">${statusIcon}</span></td>
                        </tr>
                    `;
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function fetchAllPegawai() {
            if(STATE.allPegawai.length > 0) {
                renderTablePegawai(); // Jika data sudah di-cache, langsung render halaman aktif
                return;
            } 
            showLoader();
            try {
                const res = await apiCall({ action: 'getAllData', role: STATE.user.role });
                STATE.allPegawai = res.data;
                
                // Urutkan sekali saja setelah fetch data dari database
                STATE.allPegawai.sort((a, b) => {
                    const statusA = (a.Status_Pegawai || 'AKTIF').toUpperCase();
                    const statusB = (b.Status_Pegawai || 'AKTIF').toUpperCase();
                    if (statusA === 'AKTIF' && statusB !== 'AKTIF') return -1;
                    if (statusA !== 'AKTIF' && statusB === 'AKTIF') return 1;
                    
                    const namaA = (a.Nama_Lengkap || '').toUpperCase();
                    const namaB = (b.Nama_Lengkap || '').toUpperCase();
                    return namaA.localeCompare(namaB);
                });

                // Salin ke filteredPegawai agar tidak merusak data asli
                STATE.filteredPegawai = [...STATE.allPegawai];
                STATE.currentPage = 1; // Set ke halaman pertama
                
                renderTablePegawai();
            } catch(e) {
                Swal.fire('Error', e.message, 'error');
            }
            showLoader(false);
        }

        function renderTablePegawai() {
            const tbody = document.getElementById('tbody-pegawai');
            tbody.innerHTML = '';
            
            const data = STATE.filteredPegawai;
            const totalData = data.length;
            const totalPages = Math.ceil(totalData / STATE.rowsPerPage);
            
            // Validasi Nomor Halaman
            if (STATE.currentPage < 1) STATE.currentPage = 1;
            if (STATE.currentPage > totalPages && totalPages > 0) STATE.currentPage = totalPages;
            
            // Logika Pemotongan Data (Slice)
            const startIndex = (STATE.currentPage - 1) * STATE.rowsPerPage;
            const endIndex = Math.min(startIndex + STATE.rowsPerPage, totalData);
            const paginatedData = data.slice(startIndex, endIndex);

            if (paginatedData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 opacity-70">Data pegawai tidak ditemukan.</td></tr>';
            } else {
                paginatedData.forEach(p => {
                    if(!p.NIP) return;
                    let statusBadge = p.Status_Pegawai === 'PENSIUN' ? 'bg-gray-200 text-gray-800' : 'bg-green-100 text-green-800';
                    let tr = document.createElement('tr');
                    tr.className = 'border-b border-gray-300 hover:bg-gray-100 hover:text-black transition';
                    tr.innerHTML = `
                        <td class="p-3">${p.NIP}</td>
                        <td class="p-3 font-medium">${p.Nama_Lengkap}</td>
                        <td class="p-3">${p.Jabatan_Terakhir || '-'}</td>
                        <td class="p-3"><span class="px-2 py-1 ${statusBadge} rounded text-xs font-bold">${p.Status_Pegawai || 'AKTIF'}</span></td>
                        <td class="p-3"><button onclick="editPegawaiAdmin('${p.NIP}')" class="text-blue-600 hover:underline bg-blue-50 px-2 py-1 rounded border border-blue-200 shadow-sm"><i class="fas fa-edit"></i> Edit / Aksi</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            // Update Teks Informasi Data
            document.getElementById('pagination-info').innerText = `Menampilkan ${totalData === 0 ? 0 : startIndex + 1} - ${endIndex} dari ${totalData} Pegawai`;
            
            // Render Kontrol Paginasi
            renderPaginationControls(totalPages);
        }

        function renderPaginationControls(totalPages) {
            const container = document.getElementById('pagination-controls');
            container.innerHTML = '';
            if (totalPages <= 1) return; // Sembunyikan jika hanya 1 halaman

            // Tombol Previous
            let btnPrev = document.createElement('button');
            btnPrev.className = `px-3 py-1 border border-gray-300 rounded mr-2 transition ${STATE.currentPage === 1 ? 'opacity-50 cursor-not-allowed bg-gray-100 text-gray-400' : 'bg-white hover:bg-gray-200 text-black'}`;
            btnPrev.innerHTML = '<i class="fas fa-chevron-left"></i>';
            btnPrev.disabled = STATE.currentPage === 1;
            btnPrev.onclick = () => { STATE.currentPage--; renderTablePegawai(); };
            container.appendChild(btnPrev);

            // Indikator Halaman (1 / X)
            let pageIndicator = document.createElement('span');
            pageIndicator.className = 'px-3 py-1 font-bold text-gray-700 mr-2';
            pageIndicator.innerText = `${STATE.currentPage} / ${totalPages}`;
            container.appendChild(pageIndicator);

            // Tombol Next
            let btnNext = document.createElement('button');
            btnNext.className = `px-3 py-1 border border-gray-300 rounded transition ${STATE.currentPage === totalPages ? 'opacity-50 cursor-not-allowed bg-gray-100 text-gray-400' : 'bg-white hover:bg-gray-200 text-black'}`;
            btnNext.innerHTML = '<i class="fas fa-chevron-right"></i>';
            btnNext.disabled = STATE.currentPage === totalPages;
            btnNext.onclick = () => { STATE.currentPage++; renderTablePegawai(); };
            container.appendChild(btnNext);
        }

        function filterTablePegawai() {
            const term = document.getElementById('search-pegawai').value.toLowerCase();
            
            // Filter dari allPegawai ke filteredPegawai
            STATE.filteredPegawai = STATE.allPegawai.filter(p => 
                (p.Nama_Lengkap && p.Nama_Lengkap.toLowerCase().includes(term)) || 
                (p.NIP && String(p.NIP).includes(term))
            );
            
            STATE.currentPage = 1; // Reset halaman ke 1 setiap kali melakukan pencarian baru
            renderTablePegawai();
        }

        async function editPegawaiAdmin(nip) {
            if (!['admin', 'superadmin'].includes(STATE.user.role)) return;

            const targetPegawai = STATE.allPegawai.find(p => String(p.NIP) === String(nip));
            if (!targetPegawai) return;

            const isSuperadmin = STATE.user.role === 'superadmin';

            // Opsi standar
            let options = {
                'PROFIL:Status_Pegawai': 'Ubah Status (Aktif/Pensiun)',
                'PROFIL:Jabatan_Terakhir': 'Ubah Jabatan',
                'PROFIL:Unit_Kerja': 'Ubah Unit Kerja'
            };

            // Opsi khusus Superadmin (Role & Blokir)
            if (isSuperadmin) {
                options['USERS:Role'] = 'Ubah Role Akun (user/admin/superadmin)';
                options['USERS:Status_Akun'] = 'Status Akun (Aktif/Blokir)';
            }

            const { value: selectedOption } = await Swal.fire({
                title: `Edit Pegawai`,
                text: `${targetPegawai.Nama_Lengkap}`,
                input: 'select',
                inputOptions: options,
                inputPlaceholder: 'Pilih data yang ingin diubah',
                showCancelButton: true
            });

            if (selectedOption) {
                const [targetSheet, targetKolom] = selectedOption.split(':');
                
                // Cek jika Superadmin mau ubah role tapi user belum tautkan akun ke Google
                if (targetSheet === 'USERS' && targetPegawai.Role === 'Belum Taut Akun') {
                    return Swal.fire('Gagal', 'Pegawai belum pernah Login / menautkan NIP dengan akun Google. Tidak dapat merubah Role/Status Akun.', 'error');
                }

                const { value: newVal } = await Swal.fire({
                    title: `Ubah ${targetKolom.replace('_', ' ')}`,
                    input: 'text',
                    inputValue: targetPegawai[targetKolom] || '',
                    showCancelButton: true
                });

                if (newVal) {
                    showLoader();
                    try {
                        await apiCall({
                            action: 'submitUpdate',
                            executorRole: STATE.user.role,
                            nip_target: nip, // Cukup lempar NIP, backend otomatis melacaknya!
                            sheet_target: targetSheet,
                            kolom_target: targetKolom,
                            nilai_baru: newVal
                        });
                        // Menggunakan Toast Notif
                        Toast.fire({ icon: 'success', title: 'Data berhasil diperbarui.' });
                        
                        STATE.allPegawai = []; // Reset cache
                        fetchAllPegawai(); // Muat ulang tabel
                    } catch(e) {
                        Swal.fire('Gagal', e.message, 'error');
                    }
                    showLoader(false);
                }
            }
        }

        // FUNGSI UNTUK MENU ANTRIAN (ADMIN/SUPERADMIN)
        async function fetchAllAntrian() {
            if (!['admin', 'superadmin'].includes(STATE.user.role)) return;
            showLoader();
            try {
                const res = await apiCall({ action: 'getAllAntrian', role: STATE.user.role });
                renderTableAntrian(res.data);
            } catch(e) {
                Swal.fire('Error', e.message, 'error');
            }
            showLoader(false);
        }

        function renderTableAntrian(data) {
            const tbody = document.getElementById('tbody-antrian');
            tbody.innerHTML = '';
            
            // Filter hanya data yang statusnya 'Pending'
            const pendingData = data.filter(a => a.Status === 'Pending');

            if(pendingData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 opacity-70">Tidak ada pengajuan perubahan data baru.</td></tr>';
                return;
            }

            pendingData.forEach(a => {
                const tgl = new Date(a.Tgl_Pengajuan).toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'});
                
                // PERBAIKAN: Pastikan displayNilai selalu berupa String agar tidak error .startsWith is not a function
                let displayNilai = a.Nilai_Baru !== undefined && a.Nilai_Baru !== null ? String(a.Nilai_Baru) : '';
                
                // Cek jika Nilai_Baru mengandung URL file untuk memunculkan tombol Lihat atau Base64 Image
                if(displayNilai.startsWith('data:image/')) {
                     displayNilai = `<img src="${displayNilai}" class="w-16 h-16 object-cover rounded cursor-pointer shadow border border-gray-300" onclick="Swal.fire({imageUrl: '${displayNilai}', imageWidth: 400, showConfirmButton: false})" title="Klik untuk memperbesar">`;
                } else if(displayNilai.includes('http') && displayNilai.includes('drive')) {
                     displayNilai += ` <br><a href="${displayNilai.split(' | ').pop()}" target="_blank" class="text-blue-500 underline text-xs">Lihat File Upload</a>`;
                }

                let tr = document.createElement('tr');
                tr.className = 'border-b border-gray-300 hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="p-2 text-center"><input type="checkbox" class="cb-antrian" value="${a.ID_Antrian}" onchange="checkBulkActionVisibility()"></td>
                    <td class="p-2 whitespace-nowrap">${tgl}</td>
                    <td class="p-2 font-bold">${a.Nama_Pengaju} <br><span class="text-xs text-gray-500 font-normal">NIP: ${a.NIP}</span></td>
                    <td class="p-2 text-blue-600 font-medium">${a.Kolom_Tujuan.replace(/_/g, ' ')}</td>
                    <td class="p-2 max-w-xs break-words">${displayNilai}</td>
                    <td class="p-2 whitespace-nowrap">
                        <button onclick="prosesAntrian('${a.ID_Antrian}', 'Approved')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs mr-1 shadow"><i class="fas fa-check"></i> Setuju</button>
                        <button onclick="prosesAntrian('${a.ID_Antrian}', 'Rejected')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs shadow"><i class="fas fa-times"></i> Tolak</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Pastikan select all tidak tercentang saat memuat ulang data
            document.getElementById('cb-select-all').checked = false;
            checkBulkActionVisibility();
        }

        function toggleSelectAllAntrian(source) {
            const checkboxes = document.querySelectorAll('.cb-antrian');
            checkboxes.forEach(cb => cb.checked = source.checked);
            checkBulkActionVisibility();
        }

        function checkBulkActionVisibility() {
            const anyChecked = document.querySelectorAll('.cb-antrian:checked').length > 0;
            const allCheckboxes = document.querySelectorAll('.cb-antrian').length;
            const checkedCount = document.querySelectorAll('.cb-antrian:checked').length;
            
            const container = document.getElementById('bulk-action-container');
            const selectAllCb = document.getElementById('cb-select-all');
            
            if(anyChecked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
            
            // Sync status select all checkbox
            if (checkedCount === allCheckboxes && allCheckboxes > 0) {
                selectAllCb.checked = true;
            } else {
                selectAllCb.checked = false;
            }
        }

        async function prosesBulkAntrian(action_type) {
            const checkedBoxes = document.querySelectorAll('.cb-antrian:checked');
            const ids = Array.from(checkedBoxes).map(cb => cb.value);
            
            if (ids.length === 0) return;

            const labelAksi = action_type === 'Approved' ? 'MENYETUJUI' : 'MENOLAK';
            const { isConfirmed } = await Swal.fire({
                title: 'Konfirmasi Massal',
                text: `Anda yakin ingin ${labelAksi} ${ids.length} pengajuan data sekaligus?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya, Lanjutkan',
                cancelButtonText: 'Batal'
            });

            if (isConfirmed) {
                showLoader();
                try {
                    const res = await apiCall({ action: 'processBulkAntrian', ids: ids, action_type: action_type });
                    Toast.fire({ icon: 'success', title: res.message });
                    document.getElementById('cb-select-all').checked = false;
                    checkBulkActionVisibility();
                    fetchAllAntrian(); // Refresh tabel
                } catch(e) {
                    Swal.fire('Gagal', e.message, 'error');
                }
                showLoader(false);
            }
        }

        async function prosesAntrian(id_antrian, action_type) {
            const labelAksi = action_type === 'Approved' ? 'menyetujui' : 'menolak';
            const { isConfirmed } = await Swal.fire({
                title: 'Konfirmasi',
                text: `Anda yakin ingin ${labelAksi} pengajuan data ini?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya, Lanjutkan',
                cancelButtonText: 'Batal'
            });

            if (isConfirmed) {
                showLoader();
                try {
                    const res = await apiCall({ action: 'processAntrian', id_antrian: id_antrian, action_type: action_type });
                    
                    // Menggunakan Toast Notif
                    Toast.fire({ icon: 'success', title: res.message });
                    
                    fetchAllAntrian(); // Refresh tabel setelah diproses
                } catch(e) {
                    Swal.fire('Gagal', e.message, 'error');
                }
                showLoader(false);
            }
        }

        // ==========================================
        // 4. ACTION LOGIC (UPDATE & UPLOAD)
        // ==========================================
        async function editField(sheet, kolom) {
            let inputType = 'text';
            let inputOptions = {};
            let currentValue = (sheet === 'IDENTITAS_LAIN') ? (STATE.identitasLain[kolom] || '') : (STATE.profile[kolom] || '');
            
            if (kolom === 'Jenjang_Pendidikan') {
                inputType = 'select';
                inputOptions = { 'SD /sederajat': 'SD /sederajat', 'SMP /sederajat': 'SMP /sederajat', 'SMA /sederajat': 'SMA /sederajat', 'D1': 'D1', 'D2': 'D2', 'D3': 'D3', 'D4': 'D4', 'Strata 1': 'Strata 1', 'Strata 2': 'Strata 2', 'Strata 3': 'Strata 3' };
            } else if (kolom === 'Jenis_Kelamin') {
                inputType = 'select'; inputOptions = { 'Laki-laki': 'Laki-laki', 'Perempuan': 'Perempuan' };
            } else if (kolom === 'Tgl_Lahir') { inputType = 'date'; }

            const swalConfig = { title: `Ubah ${kolom.replace(/_/g,' ')}`, input: inputType, inputValue: currentValue, showCancelButton: true };
            if (inputType === 'select') { swalConfig.inputOptions = inputOptions; swalConfig.inputPlaceholder = `-- Pilih --`; }

            const { value: newVal } = await Swal.fire(swalConfig);

            if (newVal !== undefined && newVal !== currentValue && newVal !== "") {
                let finalVal = newVal;

                // --- Formatter Khusus Nomor HP ---
                if (kolom === 'No_HP') {
                    // Hapus semua karakter selain angka (seperti -, +, spasi)
                    finalVal = finalVal.replace(/\D/g, ''); 
                    
                    // Standardisasi ke awalan 62
                    if (finalVal.startsWith('0')) {
                        finalVal = '62' + finalVal.slice(1); // Ubah 0 di depan jadi 62
                    } else if (finalVal.startsWith('8')) {
                        finalVal = '62' + finalVal; // Tambahkan 62 jika langsung diawali 8
                    } else if (!finalVal.startsWith('62')) {
                        finalVal = '62' + finalVal; // Paksa awalan 62 untuk kasus lainnya
                    }
                }
                // ---------------------------------

                showLoader();
                try {
                    await apiCall({ action: 'submitUpdate', executorRole: STATE.user.role, nip_target: STATE.user.nip, sheet_target: sheet, kolom_target: kolom, nilai_baru: finalVal });
                    Toast.fire({ icon: 'success', title: 'Pengajuan perubahan berhasil dikirim.' });
                    
                    if(['admin','superadmin'].includes(STATE.user.role)) { fetchProfile(); } 
                    else { await fetchMyAntrian(); updateProfileUI(); }
                } catch(e) { Swal.fire('Gagal', e.message, 'error'); }
                showLoader(false);
            }
        }

        // --- Fungsi Baru: Edit Spesifik Baris Riwayat ---
        async function editRiwayatRow(idData, sheet) {
            const menuOptions = {
                'RIWAYAT_PENDIDIKAN': { 'Jenjang': 'Jenjang Pendidikan', 'Instansi': 'Instansi / Kampus', 'Jurusan': 'Jurusan', 'Thn_Lulus': 'Tahun Lulus', 'No_Ijazah': 'Nomor Ijazah', 'Tgl_Ijazah': 'Tanggal Ijazah', 'Pendidikan_Terakhir': 'Pendidikan Terakhir? (Ya/Tidak)', 'File_Ijazah': 'File PDF Ijazah' },
                'RIWAYAT_PANGKAT': { 'Pangkat_Gol': 'Pangkat/Golongan', 'No_SK': 'Nomor SK', 'TMT': 'TMT Pangkat', 'Tgl_SK': 'Tanggal SK', 'Masa_Kerja_Thn': 'Masa Kerja (Tahun)', 'Masa_Kerja_Bln': 'Masa Kerja (Bulan)', 'Pangkat_Sekarang': 'Pangkat/Gol Sekarang? (Ya/Tidak)', 'File_SK': 'File PDF SK' },
                'RIWAYAT_JABATAN': { 'Jenis_Jabatan': 'Jenis Jabatan', 'Jabatan': 'Nama Jabatan', 'Eselon': 'Eselon', 'Unit_Kerja': 'Unit Kerja', 'TMT_Pelantikan': 'TMT Pelantikan', 'Jabatan_Sekarang': 'Jabatan Sekarang? (Ya/Tidak)', 'File_SK': 'File PDF SK' },
                'RIWAYAT_KOMPETENSI': { 'Jenis_Diklat': 'Jenis Diklat', 'Nama_Diklat': 'Nama Diklat', 'Tgl_Mulai': 'Tgl Mulai Diklat', 'Tgl_Selesai': 'Tgl Selesai Diklat', 'Jumlah_JP': 'Jumlah JP', 'Penyelenggara': 'Penyelenggara', 'Sumber_Anggaran': 'Sumber Anggaran', 'No_Sertifikat': 'No Sertifikat', 'File_Sertifikat': 'File PDF Sertifikat' },
                'RIWAYAT_KGB': { 'Golongan': 'Golongan KGB', 'Gaji_Baru': 'Gaji Baru', 'KGB_TMT': 'TMT KGB', 'Dasar_Nomor': 'Nomor SK Dasar' },
                'DATA_KELUARGA': { 'Nama': 'Nama Anggota', 'Status_Keluarga': 'Status (Anak/Istri)', 'L/P': 'L/P', 'Tunjangan': 'Dapat Tunjangan?' }
            };

            const dataTabelMapping = {
                'RIWAYAT_PENDIDIKAN': STATE.riwayat.pendidikan, 'RIWAYAT_PANGKAT': STATE.riwayat.pangkat,
                'RIWAYAT_JABATAN': STATE.riwayat.jabatan, 'RIWAYAT_KOMPETENSI': STATE.riwayat.kompetensi, 'RIWAYAT_KGB': STATE.riwayat.kgb, 'DATA_KELUARGA': STATE.riwayat.keluarga
            };

            const rowData = dataTabelMapping[sheet].find(r => r.ID_Data === idData);
            const kolomOptions = menuOptions[sheet];

            const { value: selectedKolom } = await Swal.fire({
                title: 'Edit Riwayat',
                input: 'select',
                inputOptions: kolomOptions,
                inputPlaceholder: 'Apa yang ingin diubah?',
                showCancelButton: true
            });

            if (selectedKolom) {
                let inputType = 'text';
                let inputOptions = {};
                
                // Dropdown spesifik untuk riwayat edit
                if (selectedKolom === 'Jenjang') { inputType = 'select'; inputOptions = { 'SD /sederajat': 'SD /sederajat', 'SMP /sederajat': 'SMP /sederajat', 'SMA /sederajat': 'SMA /sederajat', 'D1': 'D1', 'D2': 'D2', 'D3': 'D3', 'D4': 'D4', 'Strata 1': 'Strata 1', 'Strata 2': 'Strata 2', 'Strata 3': 'Strata 3' }; }
                if (selectedKolom === 'Pangkat_Gol') { 
                    inputType = 'select'; 
                    inputOptions = {
                        'Gol I': {'Juru Muda (I/a)': 'Juru Muda (I/a)', 'Juru Muda Tk.I (I/b)': 'Juru Muda Tk.I (I/b)', 'Juru (I/c)': 'Juru (I/c)', 'Juru Tk.I (I/d)': 'Juru Tk.I (I/d)'},
                        'Gol II': {'Pengatur Muda (II/a)': 'Pengatur Muda (II/a)', 'Pengatur Muda Tk.I (II/b)': 'Pengatur Muda Tk.I (II/b)', 'Pengatur (II/c)': 'Pengatur (II/c)', 'Pengatur Tk.I (II/d)': 'Pengatur Tk.I (II/d)'},
                        'Gol III': {'Penata Muda (III/a)': 'Penata Muda (III/a)', 'Penata Muda Tk.I (III/b)': 'Penata Muda Tk.I (III/b)', 'Penata (III/c)': 'Penata (III/c)', 'Penata Tk.I (III/d)': 'Penata Tk.I (III/d)'},
                        'Gol IV': {'Pembina (IV/a)': 'Pembina (IV/a)', 'Pembina Tk.I (IV/b)': 'Pembina Tk.I (IV/b)', 'Pembina Utama Muda (IV/c)': 'Pembina Utama Muda (IV/c)', 'Pembina Utama Madya (IV/d)': 'Pembina Utama Madya (IV/d)', 'Pembina Utama (IV/e)': 'Pembina Utama (IV/e)'},
                        'PPPK': {'PPPK Gol. 5': 'PPPK Gol. 5', 'PPPK Gol. 7': 'PPPK Gol. 7', 'PPPK Gol. 9': 'PPPK Gol. 9', 'PPPK Gol. 10': 'PPPK Gol. 10', 'PPPK Gol. 11': 'PPPK Gol. 11'}
                    }; 
                }
                
                // Tambahan Dropdown Khusus Jabatan
                if (selectedKolom === 'Jenis_Jabatan') { inputType = 'select'; inputOptions = { 'Staf': 'Staf', 'Jabatan Struktural': 'Jabatan Struktural', 'JFT (Jabatan Fungsional Tertentu)': 'JFT (Jabatan Fungsional Tertentu)', 'JFU (Jabatan Fungsional Umum)': 'JFU (Jabatan Fungsional Umum)', 'Jenis jabatan tidak di ketahui': 'Jenis jabatan tidak di ketahui' }; }
                if (selectedKolom === 'Eselon') { inputType = 'select'; inputOptions = { 'ESELON II': 'ESELON II', 'ESELON III': 'ESELON III', 'ESELON IV': 'ESELON IV' }; }
                if (selectedKolom === 'Sumber_Anggaran') { inputType = 'select'; inputOptions = { 'Gratis': 'Gratis', 'Mandiri': 'Mandiri', 'APBD': 'APBD' }; }
                if (selectedKolom === 'Pendidikan_Terakhir' || selectedKolom === 'Tunjangan' || selectedKolom === 'Pangkat_Sekarang' || selectedKolom === 'Jabatan_Sekarang') { inputType = 'select'; inputOptions = { 'Ya': 'Ya', 'Tidak': 'Tidak' }; }
                if (selectedKolom === 'L/P') { inputType = 'select'; inputOptions = { 'L': 'L', 'P': 'P' }; }
                if (selectedKolom.includes('Tgl_') || selectedKolom === 'TMT' || selectedKolom === 'TMT_Pelantikan') { inputType = 'date'; }
                if (selectedKolom.includes('File_')) { inputType = 'file'; } 

                const swalConfig = { title: `Ubah ${kolomOptions[selectedKolom]}`, input: inputType, showCancelButton: true };
                
                if (inputType === 'select') { 
                    swalConfig.inputOptions = inputOptions; 
                    swalConfig.inputPlaceholder = `-- Pilih --`; 
                    swalConfig.inputValue = rowData[selectedKolom] || '';
                } else if (inputType === 'file') {
                    swalConfig.inputAttributes = { accept: 'application/pdf' };
                } else {
                    swalConfig.inputValue = rowData[selectedKolom] || '';
                }

                // Logika khusus jika yang diubah adalah Lampiran File PDF
                if (inputType === 'file') {
                    swalConfig.preConfirm = async (file) => {
                        if (!file) {
                            Swal.showValidationMessage('File wajib dipilih!');
                            return false;
                        }
                        if (file.type !== 'application/pdf') {
                            Swal.showValidationMessage('Format file harus PDF!');
                            return false;
                        }
                        if (file.size > 7 * 1024 * 1024) {
                            Swal.showValidationMessage('Ukuran file maksimal 7MB!');
                            return false;
                        }
                        
                        const base64PDF = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });

                        Swal.showLoading();
                        try {
                            const resFile = await apiCall({
                                action: 'uploadFile',
                                nip: STATE.user.nip,
                                nama: STATE.profile.Nama_Lengkap,
                                fileBase64: base64PDF,
                                mimeType: file.type,
                                filename: `UPDATE_${selectedKolom}_${STATE.user.nip}_${new Date().getTime()}.pdf`
                            });
                            return resFile.fileUrl; // Kembalikan Link Drive baru untuk disimpan
                        } catch (err) {
                            Swal.showValidationMessage('Gagal mengupload file: ' + err.message);
                            return false;
                        }
                    };
                }

                const { value: newVal } = await Swal.fire(swalConfig);

                if (newVal !== undefined && newVal !== rowData[selectedKolom] && newVal !== '') {
                    showLoader();
                    try {
                        await apiCall({
                            action: 'submitUpdate', executorRole: STATE.user.role, nip_target: STATE.user.nip,
                            sheet_target: sheet, baris_target: idData, kolom_target: selectedKolom, nilai_baru: newVal
                        });
                        Toast.fire({ icon: 'success', title: 'Perubahan berhasil masuk antrian.' });
                        if(['admin','superadmin'].includes(STATE.user.role)) { fetchProfile(); } else { await fetchMyAntrian(); renderSemuaRiwayat(); }
                    } catch(e) { Swal.fire('Gagal', e.message, 'error'); }
                    showLoader(false);
                }
            }
        }

        async function ajukanRiwayat(sheet) {
            let formTitle = 'Ajukan Data';
            let htmlForm = '';

            // Buat HTML input dinamis berdasarkan tabel riwayatnya
            if (sheet === 'RIWAYAT_PENDIDIKAN') {
                formTitle = 'Ajukan Riwayat Pendidikan';
                htmlForm = `
                    <select id="swal-in1" class="swal2-select w-full m-0 mt-2 text-sm">
                        <option value="" disabled selected>-- Pilih Jenjang Pendidikan --</option>
                        <option value="SD /sederajat">SD /sederajat</option>
                        <option value="SMP /sederajat">SMP /sederajat</option>
                        <option value="SMA /sederajat">SMA /sederajat</option>
                        <option value="D1">D1</option>
                        <option value="D2">D2</option>
                        <option value="D3">D3</option>
                        <option value="D4">D4</option>
                        <option value="Strata 1">Strata 1</option>
                        <option value="Strata 2">Strata 2</option>
                        <option value="Strata 3">Strata 3</option>
                    </select>
                    <input id="swal-in2" class="swal2-input text-sm" placeholder="Nama Instansi/Kampus">
                    <input id="swal-in3" class="swal2-input text-sm" placeholder="Jurusan / Program Studi">
                    <input id="swal-in4" class="swal2-input text-sm" type="number" placeholder="Tahun Lulus (Contoh: 2018)">
                    <input id="swal-in5" class="swal2-input text-sm" placeholder="Nomor Ijazah">
                    
                    <div class="text-left mt-3 px-1"><label class="text-sm font-bold text-gray-700">Tanggal Ijazah:</label></div>
                    <input id="swal-in6" class="swal2-input text-sm m-0 w-full mb-2" type="date">
                    
                    <select id="swal-in7" class="swal2-select w-full m-0 mt-2 text-sm">
                        <option value="" disabled selected>-- Pendidikan Terakhir? --</option>
                        <option value="Ya">Ya</option>
                        <option value="Tidak">Tidak</option>
                    </select>

                    <div class="text-left mt-4 px-1"><label class="text-sm font-bold text-gray-700">File PDF Ijazah (Maks 7MB):</label></div>
                    <input type="file" id="swal-file" class="swal2-file text-sm" accept="application/pdf">
                `;
            } else if (sheet === 'RIWAYAT_PANGKAT') {
                formTitle = 'Ajukan Riwayat Pangkat';
                htmlForm = `
                    <select id="swal-in1" class="swal2-select w-full m-0 mt-2 text-sm">
                        <option value="" disabled selected>-- Pilih Pangkat/Golongan --</option>
                        <optgroup label="Golongan I (Juru)">
                            <option value="Juru Muda (I/a)">Juru Muda (I/a)</option>
                            <option value="Juru Muda Tk.I (I/b)">Juru Muda Tk.I (I/b)</option>
                            <option value="Juru (I/c)">Juru (I/c)</option>
                            <option value="Juru Tk.I (I/d)">Juru Tk.I (I/d)</option>
                        </optgroup>
                        <optgroup label="Golongan II (Pengatur)">
                            <option value="Pengatur Muda (II/a)">Pengatur Muda (II/a)</option>
                            <option value="Pengatur Muda Tk.I (II/b)">Pengatur Muda Tk.I (II/b)</option>
                            <option value="Pengatur (II/c)">Pengatur (II/c)</option>
                            <option value="Pengatur Tk.I (II/d)">Pengatur Tk.I (II/d)</option>
                        </optgroup>
                        <optgroup label="Golongan III (Penata)">
                            <option value="Penata Muda (III/a)">Penata Muda (III/a)</option>
                            <option value="Penata Muda Tk.I (III/b)">Penata Muda Tk.I (III/b)</option>
                            <option value="Penata (III/c)">Penata (III/c)</option>
                            <option value="Penata Tk.I (III/d)">Penata Tk.I (III/d)</option>
                        </optgroup>
                        <optgroup label="Golongan IV (Pembina)">
                            <option value="Pembina (IV/a)">Pembina (IV/a)</option>
                            <option value="Pembina Tk.I (IV/b)">Pembina Tk.I (IV/b)</option>
                            <option value="Pembina Utama Muda (IV/c)">Pembina Utama Muda (IV/c)</option>
                            <option value="Pembina Utama Madya (IV/d)">Pembina Utama Madya (IV/d)</option>
                            <option value="Pembina Utama (IV/e)">Pembina Utama (IV/e)</option>
                        </optgroup>
                        <optgroup label="PPPK">
                            <option value="PPPK Gol. 5">PPPK Gol. 5</option>
                            <option value="PPPK Gol. 7">PPPK Gol. 7</option>
                            <option value="PPPK Gol. 9">PPPK Gol. 9</option>
                            <option value="PPPK Gol. 10">PPPK Gol. 10</option>
                            <option value="PPPK Gol. 11">PPPK Gol. 11</option>
                        </optgroup>
                    </select>

                    <input id="swal-in2" class="swal2-input text-sm" placeholder="Nomor SK Pengangkatan">
                    
                    <div class="text-left mt-3 px-1"><label class="text-sm font-bold text-gray-700">TMT Pangkat/Golongan:</label></div>
                    <input id="swal-in3" class="swal2-input text-sm m-0 w-full mb-2" type="date">
                    
                    <div class="text-left mt-3 px-1"><label class="text-sm font-bold text-gray-700">Tanggal SK:</label></div>
                    <input id="swal-in4" class="swal2-input text-sm m-0 w-full mb-2" type="date">
                    
                    <div class="flex gap-2 px-1">
                        <input id="swal-in5" class="swal2-input text-sm w-1/2 m-0 mt-2" type="number" placeholder="Masa Kerja (Tahun)">
                        <input id="swal-in6" class="swal2-input text-sm w-1/2 m-0 mt-2" type="number" placeholder="Masa Kerja (Bulan)">
                    </div>

                    <select id="swal-in7" class="swal2-select w-full m-0 mt-3 text-sm">
                        <option value="" disabled selected>-- Pangkat/Golongan Sekarang? --</option>
                        <option value="Ya">Ya</option>
                        <option value="Tidak">Tidak</option>
                    </select>

                    <div class="text-left mt-4 px-1"><label class="text-sm font-bold text-gray-700">File PDF SK (Maks 7MB):</label></div>
                    <input type="file" id="swal-file" class="swal2-file text-sm" accept="application/pdf">
                `;
            } else if (sheet === 'RIWAYAT_JABATAN') {
                formTitle = 'Ajukan Riwayat Jabatan';
                htmlForm = `
                    <select id="swal-jenis" class="swal2-select w-full m-0 mt-2 text-sm" onchange="document.getElementById('div-eselon').style.display = this.value === 'Jabatan Struktural' ? 'block' : 'none'">
                        <option value="" disabled selected>-- Pilih Jenis Jabatan --</option>
                        <option value="Staf">Staf</option>
                        <option value="Jabatan Struktural">Jabatan Struktural</option>
                        <option value="JFT (Jabatan Fungsional Tertentu)">JFT (Jabatan Fungsional Tertentu)</option>
                        <option value="JFU (Jabatan Fungsional Umum)">JFU (Jabatan Fungsional Umum)</option>
                        <option value="Jenis jabatan tidak di ketahui">Jenis jabatan tidak di ketahui</option>
                    </select>

                    <div id="div-eselon" style="display:none;" class="mt-2 w-full">
                        <select id="swal-eselon" class="swal2-select w-full m-0 text-sm">
                            <option value="" disabled selected>-- Pilih Eselon (Jika Struktural) --</option>
                            <option value="ESELON II">ESELON II</option>
                            <option value="ESELON III">ESELON III</option>
                            <option value="ESELON IV">ESELON IV</option>
                        </select>
                    </div>

                    <select id="swal-unit" class="swal2-select w-full m-0 mt-3 text-sm" onchange="document.getElementById('div-unit-lainnya').style.display = this.value === 'LAINNYA' ? 'block' : 'none'">
                        <option value="" disabled selected>-- Pilih Unit Kerja (Bidang/Bagian/Ruangan) --</option>
                        <optgroup label="BIDANG & BAGIAN UTAMA">
                            <option value="BAGIAN PROGPEL">BAGIAN PROGPEL</option>
                            <option value="BAGIAN KEUANGAN">BAGIAN KEUANGAN</option>
                            <option value="BAGIAN ADMINISTRASI DAN UMUM">BAGIAN ADMINISTRASI DAN UMUM</option>
                            <option value="BIDANG PELAYANAN MEDIK">BIDANG PELAYANAN MEDIK</option>
                            <option value="BIDANG KEPERAWATAN">BIDANG KEPERAWATAN</option>
                            <option value="BIDANG PELAYANAN PENUNJANG">BIDANG PELAYANAN PENUNJANG</option>
                        </optgroup>
                        <optgroup label="INSTALASI & RUANGAN">
                            <option value="INSTALASI FARMASI">INSTALASI FARMASI</option>
                            <option value="INSTALASI RADIOLOGI">INSTALASI RADIOLOGI</option>
                            <option value="INSTALASI BEDAH SENTRAL">INSTALASI BEDAH SENTRAL</option>
                            <option value="INSTALASI GAWAT DARURAT">INSTALASI GAWAT DARURAT</option>
                            <option value="ICU">ICU</option>
                            <option value="ICCU">ICCU</option>
                            <option value="HCU">HCU</option>
                            <option value="INSTALASI LABORATORIUM">INSTALASI LABORATORIUM</option>
                            <option value="INSTALASI HEMODIALISA">INSTALASI HEMODIALISA</option>
                            <option value="INSTALASI GIZI">INSTALASI GIZI</option>
                            <option value="INSTALASI REKAM MEDIK">INSTALASI REKAM MEDIK</option>
                            <option value="INSTALASI PEMELIHARAAN SARANA">INSTALASI PEMELIHARAAN SARANA</option>
                            <option value="INSTALASI PENYEHATAN LINGKUNGAN">INSTALASI PENYEHATAN LINGKUNGAN</option>
                            <option value="INSTALASI FORENSIK DAN MEDIKOLEGAL">INSTALASI FORENSIK DAN MEDIKOLEGAL</option>
                            <option value="INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER">INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER</option>
                            <option value="INSTALASI MATERNAL DAN PERINATAL">INSTALASI MATERNAL DAN PERINATAL</option>
                            <option value="INSTALASI REHABILITASI MEDIK">INSTALASI REHABILITASI MEDIK</option>
                            <option value="INSTALASI SIM RS">INSTALASI SIM RS</option>
                            <option value="INSTALASI PKRS">INSTALASI PKRS</option>
                            <option value="POLI KIR">POLI KIR</option>
                            <option value="POLI EKSKUTIF">POLI EKSKUTIF</option>
                            <option value="POLI TMS">POLI TMS</option>
                            <option value="POLI EEG">POLI EEG</option>
                            <option value="POLI ENDOSKOPI">POLI ENDOSKOPI</option>
                            <option value="POLI ESWL">POLI ESWL</option>
                            <option value="RUANG MAWAR/ASTER">RUANG MAWAR/ASTER</option>
                            <option value="RUANG ANYELIR/MELATI">RUANG ANYELIR/MELATI</option>
                            <option value="RUANG ANGGREK/DAHLIA">RUANG ANGGREK/DAHLIA</option>
                            <option value="RUANG BOUGENVILLE">RUANG BOUGENVILLE</option>
                            <option value="RUANG TERATAI/ASOKA">RUANG TERATAI/ASOKA</option>
                            <option value="RUANG LILY">RUANG LILY</option>
                            <option value="RUANG FLAMBOYAN">RUANG FLAMBOYAN</option>
                            <option value="POLI ANAK">POLI ANAK</option>
                            <option value="POLI PENYAKIT DALAM">POLI PENYAKIT DALAM</option>
                            <option value="POLI BEDAH">POLI BEDAH</option>
                            <option value="POLI MATA">POLI MATA</option>
                            <option value="POLI THT">POLI THT</option>
                            <option value="POLI SYARAF">POLI SYARAF</option>
                            <option value="POLI JANTUNG">POLI JANTUNG</option>
                            <option value="POLI PARU">POLI PARU</option>
                            <option value="POLI GIGI">POLI GIGI</option>
                            <option value="POLI KULIT DAN KELAMIN">POLI KULIT DAN KELAMIN</option>
                            <option value="POLI JIWA">POLI JIWA</option>
                            <option value="POLI TB">POLI TB</option>
                            <option value="POLI VCT">POLI VCT</option>
                            <option value="POLI UMUM">POLI UMUM</option>
                            <option value="POLI GERIATRI">POLI GERIATRI</option>
                            <option value="POLI UROLOGI">POLI UROLOGI</option>
                            <option value="POLI ORTHOPEDI">POLI ORTHOPEDI</option>
                            <option value="POLI OBSGYN">POLI OBSGYN</option>
                            <option value="POLI BEDAH SYARAF">POLI BEDAH SYARAF</option>
                        </optgroup>
                        <optgroup label="KOMITE & UNIT LAIN">
                            <option value="KOMITE MEDIK">KOMITE MEDIK</option>
                            <option value="KOMITE KEPERAWATAN">KOMITE KEPERAWATAN</option>
                            <option value="KOMITE PPI">KOMITE PPI</option>
                            <option value="KOMITE KESEHATAN DAN KESELAMATAN KERJA">KOMITE KESEHATAN DAN KESELAMATAN KERJA</option>
                            <option value="SATUAN PEMERIKSAAN INTERNAL">SATUAN PEMERIKSAAN INTERNAL</option>
                            <option value="UNIT AMBULAN">UNIT AMBULAN</option>
                            <option value="UNIT LOUNDRY">UNIT LOUNDRY</option>
                            <option value="UNIT CSSD">UNIT CSSD</option>
                            <option value="UNIT PENGADUAN">UNIT PENGADUAN</option>
                            <option value="UNIT DIKLAT">UNIT DIKLAT</option>
                            <option value="UNIT KLAIM DAN PENJAMINAN">UNIT KLAIM DAN PENJAMINAN</option>
                            <option value="LAINNYA">Lainnya (Ketik Manual)...</option>
                        </optgroup>
                    </select>

                    <div id="div-unit-lainnya" style="display:none;" class="mt-2 w-full">
                        <input id="swal-unit-lainnya" class="swal2-input text-sm m-0 w-full" placeholder="Ketik Unit Kerja Lainnya">
                    </div>

                    <input id="swal-nama" class="swal2-input text-sm m-0 mt-3 w-full" placeholder="Nama Jabatan">

                    <div class="text-left mt-3 px-1"><label class="text-sm font-bold text-gray-700">TMT Pelantikan:</label></div>
                    <input id="swal-tmt" class="swal2-input text-sm m-0 w-full mb-2" type="date">

                    <select id="swal-sekarang" class="swal2-select w-full m-0 mt-2 text-sm">
                        <option value="" disabled selected>-- Jabatan Sekarang? --</option>
                        <option value="Ya">Ya</option>
                        <option value="Tidak">Tidak</option>
                    </select>

                    <div class="text-left mt-4 px-1"><label class="text-sm font-bold text-gray-700">File PDF SK (Maks 7MB):</label></div>
                    <input type="file" id="swal-file" class="swal2-file text-sm" accept="application/pdf">
                `;
            } else if (sheet === 'RIWAYAT_KOMPETENSI') {
                formTitle = 'Pengembangan Kompetensi / Diklat';
                htmlForm = `
                    <input id="swal-in1" class="swal2-input text-sm" placeholder="Jenis Diklat (Contoh: Teknis, Kepemimpinan)">
                    <input id="swal-in2" class="swal2-input text-sm" placeholder="Nama Diklat">
                    
                    <div class="flex gap-2 px-1 mt-3">
                        <div class="w-1/2 text-left"><label class="text-sm font-bold text-gray-700">Tgl Mulai:</label></div>
                        <div class="w-1/2 text-left"><label class="text-sm font-bold text-gray-700">Tgl Selesai:</label></div>
                    </div>
                    <div class="flex gap-2 px-1">
                        <input id="swal-in3" class="swal2-input text-sm w-1/2 m-0" type="date">
                        <input id="swal-in4" class="swal2-input text-sm w-1/2 m-0" type="date">
                    </div>

                    <input id="swal-in5" class="swal2-input text-sm" type="number" placeholder="Jumlah JP (Jam Pelajaran)">
                    <input id="swal-in6" class="swal2-input text-sm" placeholder="Penyelenggara Instansi">
                    
                    <select id="swal-in7" class="swal2-select w-full m-0 mt-3 text-sm">
                        <option value="" disabled selected>-- Pilih Sumber Anggaran --</option>
                        <option value="Gratis">Gratis</option>
                        <option value="Mandiri">Mandiri</option>
                        <option value="APBD">APBD</option>
                    </select>

                    <input id="swal-in8" class="swal2-input text-sm" placeholder="Nomor Sertifikat">

                    <div class="text-left mt-4 px-1"><label class="text-sm font-bold text-gray-700">File PDF Sertifikat (Maks 7MB):</label></div>
                    <input type="file" id="swal-file" class="swal2-file text-sm" accept="application/pdf">
                `;
            } else if (sheet === 'RIWAYAT_KGB') {
                formTitle = 'Ajukan Riwayat KGB';
                htmlForm = `
                    <input id="swal-in1" class="swal2-input" placeholder="Golongan">
                    <input id="swal-in2" class="swal2-input" placeholder="Gaji Pokok Baru">
                    <input id="swal-in3" class="swal2-input" placeholder="TMT KGB">
                    <input id="swal-in4" class="swal2-input" placeholder="Nomor SK Dasar">
                `;
            } else if (sheet === 'DATA_KELUARGA') {
                formTitle = 'Ajukan Data Keluarga';
                htmlForm = `
                    <input id="swal-in1" class="swal2-input" placeholder="Nama Anggota Keluarga">
                    <input id="swal-in2" class="swal2-input" placeholder="Status (Contoh: Anak / Istri)">
                    <input id="swal-in3" class="swal2-input" placeholder="Jenis Kelamin (L/P)">
                    <input id="swal-in4" class="swal2-input" placeholder="Tunjangan (Ya/Tidak)">
                `;
            }

            const { value: formValues } = await Swal.fire({
                title: formTitle,
                html: htmlForm,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Ajukan',
                preConfirm: async () => {
                    let vals = [];
                    
                    // Logika Ekstraksi Form Khusus Jabatan (Banyak Dropdown Bersyarat)
                    if (sheet === 'RIWAYAT_JABATAN') {
                        const jenis = document.getElementById('swal-jenis')?.value;
                        if (!jenis) { Swal.showValidationMessage('Jenis Jabatan wajib diisi!'); return false; }
                        
                        const eselon = jenis === 'Jabatan Struktural' ? (document.getElementById('swal-eselon')?.value || '-') : '-';
                        
                        let unit = document.getElementById('swal-unit')?.value;
                        if (!unit) { Swal.showValidationMessage('Unit Kerja wajib dipilih!'); return false; }
                        if (unit === 'LAINNYA') {
                            unit = document.getElementById('swal-unit-lainnya')?.value;
                            if (!unit) { Swal.showValidationMessage('Unit Kerja Lainnya wajib diketik!'); return false; }
                        }
                        
                        const nama = document.getElementById('swal-nama')?.value || '-';
                        const tmt = document.getElementById('swal-tmt')?.value || '-';
                        const sekarang = document.getElementById('swal-sekarang')?.value || '-';
                        
                        vals = [jenis, eselon, unit, nama, tmt, sekarang];
                    } else {
                        // Mengambil nilai dinamis sesuai jumlah input swal-in (Standar Umum)
                        let idx = 1;
                        while(true) {
                            const el = document.getElementById('swal-in'+idx);
                            if(!el) break;
                            vals.push(el.value || '-');
                            idx++;
                        }
                    }

                    // Logika Wajib Upload PDF untuk Pendidikan, Pangkat, Jabatan & Kompetensi
                    if (sheet === 'RIWAYAT_PENDIDIKAN' || sheet === 'RIWAYAT_PANGKAT' || sheet === 'RIWAYAT_JABATAN' || sheet === 'RIWAYAT_KOMPETENSI') {
                        const fileInput = document.getElementById('swal-file');
                        if (!fileInput.files.length) {
                            Swal.showValidationMessage('File PDF wajib dilampirkan!');
                            return false;
                        }
                        const file = fileInput.files[0];
                        if (file.type !== 'application/pdf') {
                            Swal.showValidationMessage('Format file harus berupa PDF!');
                            return false;
                        }
                        if (file.size > 7 * 1024 * 1024) {
                            Swal.showValidationMessage('Ukuran file PDF tidak boleh lebih dari 7 MB!');
                            return false;
                        }

                        const base64PDF = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });

                        Swal.showLoading();
                        try {
                            let fNamePrefix = 'SK';
                            if(sheet === 'RIWAYAT_PENDIDIKAN') fNamePrefix = 'IJAZAH';
                            if(sheet === 'RIWAYAT_PANGKAT') fNamePrefix = 'SK_PANGKAT';
                            if(sheet === 'RIWAYAT_JABATAN') fNamePrefix = 'SK_JABATAN';
                            if(sheet === 'RIWAYAT_KOMPETENSI') fNamePrefix = 'SERTIFIKAT_DIKLAT';
                            
                            const resFile = await apiCall({
                                action: 'uploadFile',
                                nip: STATE.user.nip,
                                nama: STATE.profile.Nama_Lengkap,
                                fileBase64: base64PDF,
                                mimeType: file.type,
                                filename: `${fNamePrefix}_${STATE.user.nip}_${new Date().getTime()}.pdf`
                            });
                            vals.push(resFile.fileUrl); 
                        } catch (err) {
                            Swal.showValidationMessage('Gagal mengupload file: ' + err.message);
                            return false;
                        }
                    }

                    return vals;
                }
            });

            if (formValues && formValues.length > 0) {
                const nilaiGabungan = formValues.join(' | ');
                showLoader();
                try {
                    const res = await apiCall({
                        action: 'submitUpdate',
                        executorRole: STATE.user.role,
                        nip_target: STATE.user.nip,
                        sheet_target: sheet,
                        kolom_target: 'Pengajuan Data Baru',
                        nilai_baru: nilaiGabungan
                    });
                    
                    Toast.fire({ icon: 'success', title: 'Pengajuan data masuk antrian.' });
                    
                    if(['admin','superadmin'].includes(STATE.user.role)) { fetchProfile(); } else { fetchMyAntrian(); }
                } catch(e) {
                    Swal.fire('Gagal', e.message, 'error');
                }
                showLoader(false);
            }
        }

        function uploadFoto(input) {
            if(!input.files[0]) return;
            const file = input.files[0];
            
            if(file.size > 7 * 1024 * 1024) { return Swal.fire('Ditolak', 'Ukuran file terlalu besar! Maksimal 7 MB.', 'error'); }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = async function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400; const MAX_HEIGHT = 400;
                    let width = img.width; let height = img.height;

                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } 
                    else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                    
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);

                    showLoader();
                    try {
                        await apiCall({ action: 'submitUpdate', executorRole: STATE.user.role, nip_target: STATE.user.nip, sheet_target: 'PROFIL', kolom_target: 'URL_Foto_Profil', nilai_baru: compressedBase64 });
                        document.getElementById('profile-img').src = compressedBase64;
                        if(STATE.profile) STATE.profile.URL_Foto_Profil = compressedBase64;
                        Toast.fire({ icon: 'success', title: 'Foto profil diperbarui.' });
                    } catch(err) { Swal.fire('Error', err.message, 'error'); }
                    showLoader(false);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ==========================================
        // 5. EXPORT LOGIC (SheetJS & html2pdf)
        // ==========================================
        function exportToExcel() {
            if(!STATE.allPegawai || STATE.allPegawai.length === 0) return Swal.fire('Info', 'Data belum dimuat', 'info');
            const ws = XLSX.utils.json_to_sheet(STATE.allPegawai);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Pegawai");
            XLSX.writeFile(wb, "Data_Pegawai_RSUD_Koesma.xlsx");
        }

        function exportMyData() {
            if (!STATE.profile) return Swal.fire('Info', 'Data profil belum dimuat', 'info');
            showLoader(true);
            
            const cvContainer = document.createElement('div');
            cvContainer.style.padding = '20px';
            cvContainer.style.fontFamily = 'Arial, sans-serif';
            cvContainer.style.color = '#000';
            cvContainer.style.backgroundColor = '#fff';

            const p = STATE.profile || {};
            const namaLengkap = (p.Gelar_Depan ? p.Gelar_Depan + ' ' : '') + (p.Nama_Lengkap || '-') + (p.Gelar_Belakang ? ', ' + p.Gelar_Belakang : '');
            
            // Note: colCount yang dilempar sama dengan colCount dari tabel aslinya MINUS kolom "Aksi" 
            const extractTable = (tbodyId, colCount) => {
                const tbody = document.getElementById(tbodyId);
                if (!tbody || tbody.innerText.includes('Belum ada data') || tbody.innerText.includes('Sedang memuat')) {
                    return `<tr><td colspan="${colCount}" style="padding:8px; border:1px solid #ddd; text-align:center;">Tidak ada data</td></tr>`;
                }
                let rowsHtml = '';
                for(let tr of tbody.querySelectorAll('tr')) {
                    let rowHtml = '<tr>';
                    let tdCount = 0;
                    for(let td of tr.querySelectorAll('td')) {
                        if(tdCount >= colCount) break; 
                        let clone = td.cloneNode(true);
                        let elementsToRemove = clone.querySelectorAll('i, button, a, span.text-xs');
                        elementsToRemove.forEach(el => el.remove());
                        rowHtml += `<td style="padding:8px; border:1px solid #ddd;">${clone.innerText.trim()}</td>`;
                        tdCount++;
                    }
                    rowHtml += '</tr>';
                    rowsHtml += rowHtml;
                }
                return rowsHtml;
            };

            cvContainer.innerHTML = `
                <div style="text-align:center; margin-bottom: 20px;">
                    <h2 style="margin:0; font-size:22px; font-weight:bold;">DAFTAR RIWAYAT HIDUP (CV)</h2>
                    <h3 style="margin:5px 0 0 0; font-size:18px;">RSUD dr. R. KOESMA KABUPATEN TUBAN</h3>
                    <hr style="margin-top:15px; border:1px solid #333;">
                </div>
                
                <table style="width:100%; margin-bottom:20px;">
                    <tr>
                        <td style="width:130px; vertical-align:top;">
                            <div style="width:110px; height:140px; border:2px solid #333; background-image: url('${p.URL_Foto_Profil || 'https://via.placeholder.com/150'}'); background-size: cover; background-position: center top; background-repeat: no-repeat;"></div>
                        </td>
                        <td style="vertical-align:top; padding-left:15px;">
                            <h3 style="margin:0 0 10px 0; font-size:18px; text-transform:uppercase;">${namaLengkap}</h3>
                            <table style="font-size:13px; text-align:left;">
                                <tr><td style="padding-bottom:5px; width:100px;"><strong>NIP</strong></td><td style="padding-bottom:5px;">: ${p.NIP || '-'}</td></tr>
                                <tr><td style="padding-bottom:5px;"><strong>Pangkat/Gol</strong></td><td style="padding-bottom:5px;">: ${p.Pangkat_Golongan || '-'}</td></tr>
                                <tr><td style="padding-bottom:5px;"><strong>Jabatan</strong></td><td style="padding-bottom:5px;">: ${p.Jabatan_Terakhir || '-'}</td></tr>
                                <tr><td style="padding-bottom:5px;"><strong>Unit Kerja</strong></td><td style="padding-bottom:5px;">: ${p.Unit_Kerja || '-'}</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>

                <h4 style="background-color:#f0f0f0; padding:8px; margin:10px 0; border:1px solid #ddd; font-size:14px;">I. KETERANGAN PERORANGAN</h4>
                <table style="width:100%; border-collapse:collapse; font-size:12px; margin-bottom:15px;">
                    <tr><td style="width:30%; padding:5px; border:1px solid #ddd;">Tempat, Tanggal Lahir</td><td style="padding:5px; border:1px solid #ddd;">${p.Tempat_Lahir || '-'}, ${p.Tgl_Lahir ? new Date(p.Tgl_Lahir).toLocaleDateString('id-ID') : '-'}</td></tr>
                    <tr><td style="padding:5px; border:1px solid #ddd;">Jenis Kelamin</td><td style="padding:5px; border:1px solid #ddd;">${p.Jenis_Kelamin || '-'}</td></tr>
                    <tr><td style="padding:5px; border:1px solid #ddd;">Agama</td><td style="padding:5px; border:1px solid #ddd;">${p.Agama || '-'}</td></tr>
                    <tr><td style="padding:5px; border:1px solid #ddd;">Alamat</td><td style="padding:5px; border:1px solid #ddd;">${p.Alamat_Domisili || '-'}</td></tr>
                    <tr><td style="padding:5px; border:1px solid #ddd;">No HP</td><td style="padding:5px; border:1px solid #ddd;">${p.No_HP || '-'}</td></tr>
                    <tr><td style="padding:5px; border:1px solid #ddd;">Jenis ASN</td><td style="padding:5px; border:1px solid #ddd;">${p.Jenis_ASN || '-'}</td></tr>
                </table>

                <h4 style="background-color:#f0f0f0; padding:8px; margin:10px 0; border:1px solid #ddd; font-size:14px;">II. RIWAYAT PENDIDIKAN</h4>
                <table style="width:100%; border-collapse:collapse; font-size:12px; margin-bottom:15px; text-align:left;">
                    <thead><tr style="background-color:#eee;">
                        <th style="padding:8px; border:1px solid #ddd;">Jenjang</th>
                        <th style="padding:8px; border:1px solid #ddd;">Instansi</th>
                        <th style="padding:8px; border:1px solid #ddd;">Jurusan</th>
                        <th style="padding:8px; border:1px solid #ddd;">Thn Lulus</th>
                        <th style="padding:8px; border:1px solid #ddd;">No. Ijazah</th>
                        <th style="padding:8px; border:1px solid #ddd;">Tgl Ijazah</th>
                        <th style="padding:8px; border:1px solid #ddd;">Pdd. Terakhir</th>
                    </tr></thead>
                    <tbody>${extractTable('tbody-pendidikan', 7)}</tbody>
                </table>

                <h4 style="background-color:#f0f0f0; padding:8px; margin:10px 0; border:1px solid #ddd; font-size:14px;">III. RIWAYAT PANGKAT / GOLONGAN</h4>
                <table style="width:100%; border-collapse:collapse; font-size:12px; margin-bottom:15px; text-align:left;">
                    <thead><tr style="background-color:#eee;">
                        <th style="padding:8px; border:1px solid #ddd;">Pangkat/Gol</th>
                        <th style="padding:8px; border:1px solid #ddd;">No SK</th>
                        <th style="padding:8px; border:1px solid #ddd;">TMT</th>
                        <th style="padding:8px; border:1px solid #ddd;">Tgl SK</th>
                        <th style="padding:8px; border:1px solid #ddd;">Masa Kerja</th>
                        <th style="padding:8px; border:1px solid #ddd;">Pangkat Sekarang</th>
                    </tr></thead>
                    <tbody>${extractTable('tbody-pangkat', 6)}</tbody>
                </table>

                <h4 style="background-color:#f0f0f0; padding:8px; margin:10px 0; border:1px solid #ddd; font-size:14px;">IV. RIWAYAT JABATAN</h4>
                <table style="width:100%; border-collapse:collapse; font-size:12px; margin-bottom:15px; text-align:left;">
                    <thead><tr style="background-color:#eee;">
                        <th style="padding:8px; border:1px solid #ddd;">Jenis Jabatan</th>
                        <th style="padding:8px; border:1px solid #ddd;">Nama Jabatan</th>
                        <th style="padding:8px; border:1px solid #ddd;">Eselon</th>
                        <th style="padding:8px; border:1px solid #ddd;">Unit Kerja</th>
                        <th style="padding:8px; border:1px solid #ddd;">TMT Pelantikan</th>
                        <th style="padding:8px; border:1px solid #ddd;">Jabatan Sekarang</th>
                    </tr></thead>
                    <tbody>${extractTable('tbody-jabatan', 6)}</tbody>
                </table>

                <h4 style="background-color:#f0f0f0; padding:8px; margin:10px 0; border:1px solid #ddd; font-size:14px;">V. PENGEMBANGAN KOMPETENSI / DIKLAT</h4>
                <table style="width:100%; border-collapse:collapse; font-size:12px; margin-bottom:15px; text-align:left;">
                    <thead><tr style="background-color:#eee;">
                        <th style="padding:8px; border:1px solid #ddd;">Jenis Diklat</th>
                        <th style="padding:8px; border:1px solid #ddd;">Nama Diklat</th>
                        <th style="padding:8px; border:1px solid #ddd;">Pelaksanaan</th>
                        <th style="padding:8px; border:1px solid #ddd;">JP</th>
                        <th style="padding:8px; border:1px solid #ddd;">Penyelenggara</th>
                        <th style="padding:8px; border:1px solid #ddd;">Anggaran</th>
                        <th style="padding:8px; border:1px solid #ddd;">No. Sertifikat</th>
                    </tr></thead>
                    <tbody>${extractTable('tbody-kompetensi', 7)}</tbody>
                </table>

                <h4 style="background-color:#f0f0f0; padding:8px; margin:10px 0; border:1px solid #ddd; font-size:14px;">VI. RIWAYAT KGB</h4>
                <table style="width:100%; border-collapse:collapse; font-size:12px; margin-bottom:15px; text-align:left;">
                    <thead><tr style="background-color:#eee;"><th style="padding:8px; border:1px solid #ddd;">Golongan</th><th style="padding:8px; border:1px solid #ddd;">Gaji Baru</th><th style="padding:8px; border:1px solid #ddd;">TMT</th><th style="padding:8px; border:1px solid #ddd;">No SK Dasar</th></tr></thead>
                    <tbody>${extractTable('tbody-kgb', 4)}</tbody>
                </table>

                <h4 style="background-color:#f0f0f0; padding:8px; margin:10px 0; border:1px solid #ddd; font-size:14px;">VII. DATA KELUARGA</h4>
                <table style="width:100%; border-collapse:collapse; font-size:12px; margin-bottom:15px; text-align:left;">
                    <thead><tr style="background-color:#eee;"><th style="padding:8px; border:1px solid #ddd;">Nama</th><th style="padding:8px; border:1px solid #ddd;">Status</th><th style="padding:8px; border:1px solid #ddd;">L/P</th><th style="padding:8px; border:1px solid #ddd;">Tunjangan</th></tr></thead>
                    <tbody>${extractTable('tbody-keluarga', 4)}</tbody>
                </table>
            `;

            const opt = { margin: 10, filename: `CV_${namaLengkap}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().set(opt).from(cvContainer).save().then(() => { showLoader(false); }).catch(err => { showLoader(false); Swal.fire('Error', 'Gagal mencetak PDF: ' + err.message, 'error'); });
        }

        async function apiCall(payload) {
            const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            const data = await response.json();
            if (data.status === 'error') throw new Error(data.message);
            return data;
        }

    </script>
</body>
</html>
